# æœªè¿ç§»åŠŸèƒ½æ¸…å•

## ğŸ” æ£€æŸ¥ç»“æœ

ç»è¿‡å¿«é€Ÿæ£€æŸ¥ `main.py`ï¼Œå‘ç°ä»¥ä¸‹åŠŸèƒ½**å°šæœªå®Œå…¨è¿ç§»**åˆ°æ–°æ¶æ„ï¼š

### 1. âš ï¸ Bot äº‹ä»¶å¤„ç†å™¨ï¼ˆéƒ¨åˆ†ç¼ºå¤±ï¼‰

#### å·²è¿ç§» âœ…

- `/start` - å¯åŠ¨å‘½ä»¤
- `/bind_group` - ç»‘å®šç¾¤ç»„
- `/join_upline` - åŠ å…¥ä¸Šå±‚ç¾¤
- `/check_status` - æ£€æŸ¥çŠ¶æ€
- `/my_team` - æˆ‘çš„å›¢é˜Ÿ
- `open_vip_balance_callback` - ä½™é¢å¼€é€š VIP
- `confirm_vip_callback` - ç¡®è®¤å¼€é€š VIP
- `fission_handler` - ç¾¤è£‚å˜åŠ å…¥
- `profile_handler` - ä¸ªäººä¸­å¿ƒï¼ˆåŸºç¡€ç‰ˆï¼‰

#### æœªè¿ç§» âŒ

1. **`/test_link`** (ç¬¬ 6481 è¡Œ)

   - åŠŸèƒ½ï¼šæµ‹è¯•è´¦å·å…³è”çŠ¶æ€
   - ç”¨é€”ï¼šè°ƒè¯•è´¦å·å…³è”åŠŸèƒ½

2. **`/myid`** (ç¬¬ 6516 è¡Œ)

   - åŠŸèƒ½ï¼šæŸ¥çœ‹å½“å‰è´¦å· ID å’Œä¸»è´¦å· ID
   - ç”¨é€”ï¼šç”¨æˆ·æŸ¥çœ‹è´¦å·ä¿¡æ¯

3. **`/link`** (ç¬¬ 6530 è¡Œ)

   - åŠŸèƒ½ï¼šè´¦å·å…³è”å‘½ä»¤ `/link <backup_id> @username`
   - ç”¨é€”ï¼šæ‰‹åŠ¨å…³è”å¤‡ç”¨è´¦å·

4. **`message_handler`** (ç¬¬ 3118 è¡Œ)

   - åŠŸèƒ½ï¼šå¤„ç†æç°é‡‘é¢å’Œåœ°å€è¾“å…¥
   - ç”¨é€”ï¼šæç°æµç¨‹çš„å…³é”®éƒ¨åˆ†
   - **é‡è¦**ï¼šè¿™ä¸ªå¿…é¡»è¿ç§»ï¼

5. **`group_welcome_handler`** (ç¬¬ 1070 è¡Œ)

   - åŠŸèƒ½ï¼šæ–°æˆå‘˜åŠ å…¥ç¾¤æ—¶å‘é€æ¬¢è¿è¯­ï¼Œè‡ªåŠ¨æ³¨å†Œä¸ºé‚€è¯·è€…ä¸‹çº§
   - ç”¨é€”ï¼šè‡ªåŠ¨æ³¨å†ŒåŠŸèƒ½
   - **é‡è¦**ï¼šè¿™ä¸ªå¿…é¡»è¿ç§»ï¼

6. **`view_fission_handler`** (ç¬¬ 1337 è¡Œ)

   - åŠŸèƒ½ï¼šæŸ¥çœ‹è£‚å˜æ•°æ®
   - ç”¨é€”ï¼šç”¨æˆ·æŸ¥çœ‹å›¢é˜Ÿæ•°æ®

7. **`promote_handler`** (ç¬¬ 1696 è¡Œ)

   - åŠŸèƒ½ï¼šèµšé’±æ¨å¹¿
   - ç”¨é€”ï¼šç”¨æˆ·è·å–æ¨å¹¿é“¾æ¥

8. **`resources_handler`** (ç¬¬ 1754 è¡Œ)

   - åŠŸèƒ½ï¼šè¡Œä¸šèµ„æº
   - ç”¨é€”ï¼šç”¨æˆ·æµè§ˆèµ„æº

9. **`support_handler`** (ç¬¬ 1920 è¡Œ)

   - åŠŸèƒ½ï¼šåœ¨çº¿å®¢æœ
   - ç”¨é€”ï¼šç”¨æˆ·è”ç³»å®¢æœ

10. **`vip_handler`** (ç¬¬ 1954 è¡Œ)

    - åŠŸèƒ½ï¼šå¼€é€šä¼šå‘˜
    - ç”¨é€”ï¼šVIP å¼€é€šå…¥å£

11. **`my_promote_handler`** (ç¬¬ 2006 è¡Œ)

    - åŠŸèƒ½ï¼šæˆ‘çš„æ¨å¹¿
    - ç”¨é€”ï¼šæŸ¥çœ‹æ¨å¹¿æ•°æ®

12. **`back_handler`** (ç¬¬ 2045 è¡Œ)

    - åŠŸèƒ½ï¼šè¿”å›ä¸»èœå•
    - ç”¨é€”ï¼šå¯¼èˆªåŠŸèƒ½

13. **`admin_handler`** (ç¬¬ 2072 è¡Œ)

    - åŠŸèƒ½ï¼šç®¡ç†åå°
    - ç”¨é€”ï¼šç®¡ç†å‘˜åŠŸèƒ½å…¥å£

14. **å„ç§ Callback å¤„ç†å™¨**ï¼š
    - `view_level_members` - æŸ¥çœ‹å±‚çº§ä¼šå‘˜
    - `fission_main_menu` - è£‚å˜ä¸»èœå•
    - `view_level_detail_callback` - æŸ¥çœ‹å±‚çº§è¯¦æƒ…
    - `back_to_fission_callback` - è¿”å›è£‚å˜
    - `category_page_callback` - èµ„æºåˆ†ç±»ç¿»é¡µ
    - `res_back_main_callback` - èµ„æºè¿”å›ä¸»èœå•
    - `category_callback` - èµ„æºåˆ†ç±»
    - `resource_page_callback` - èµ„æºç¿»é¡µ
    - `back_to_categories_callback` - è¿”å›åˆ†ç±»
    - `admin_set_level_callback` - ç®¡ç†å‘˜è®¾ç½®å±‚çº§
    - `admin_set_reward_callback` - ç®¡ç†å‘˜è®¾ç½®å¥–åŠ±
    - `admin_set_vip_price_callback` - ç®¡ç†å‘˜è®¾ç½® VIP ä»·æ ¼
    - `admin_set_withdraw_callback` - ç®¡ç†å‘˜è®¾ç½®æç°
    - `admin_set_support_callback` - ç®¡ç†å‘˜è®¾ç½®å®¢æœ
    - `admin_stats_callback` - ç®¡ç†å‘˜ç»Ÿè®¡
    - `admin_manual_vip_callback` - ç®¡ç†å‘˜æ‰‹åŠ¨å¼€é€š VIPï¼ˆå·²ä¿®å¤ä½†æœªè¿ç§»ï¼‰
    - `admin_broadcast_callback` - ç®¡ç†å‘˜å¹¿æ’­
    - `set_group_callback` - è®¾ç½®ç¾¤ç»„
    - `set_backup_callback` - è®¾ç½®å¤‡ç”¨å·
    - `open_vip_callback` - å¼€é€š VIP å…¥å£
    - `recharge_balance_callback` - å……å€¼ä½™é¢
    - `recharge_for_vip_callback` - å……å€¼å¼€é€š VIP
    - `verify_groups_callback` - éªŒè¯ç¾¤ç»„
    - `recharge_vip_callback` - å……å€¼ VIP
    - `earnings_history_callback` - æ”¶ç›Šè®°å½•
    - `back_to_profile_callback` - è¿”å›ä¸ªäººä¸­å¿ƒ
    - `withdraw_callback` - æç°
    - `do_recharge_callback` - å……å€¼
    - `back_to_recharge_callback` - è¿”å›å……å€¼
    - `recharge_amount_callback` - å……å€¼é‡‘é¢é€‰æ‹©
    - `cancel_order_callback` - å–æ¶ˆè®¢å•
    - `share_promote_callback` - åˆ†äº«æ¨å¹¿
    - `level_detail_callback` - å±‚çº§è¯¦æƒ…

### 2. âš ï¸ æ”¯ä»˜ç›¸å…³å‡½æ•°ï¼ˆéƒ¨åˆ†ç¼ºå¤±ï¼‰

#### å·²è¿ç§» âœ…

- `process_recharge` - å¤„ç†å……å€¼ï¼ˆå·²åœ¨ bot_logic.pyï¼‰

#### æœªè¿ç§» âŒ

1. **`check_usdt_transaction`** (ç¬¬ 813 è¡Œ)

   - åŠŸèƒ½ï¼šæŸ¥è¯¢ USDT TRC20 åœ°å€çš„äº¤æ˜“è®°å½•
   - ç”¨é€”ï¼šæ£€æŸ¥å……å€¼æ˜¯å¦åˆ°è´¦

2. **`check_payment_task`** (ç¬¬ 910 è¡Œ)

   - åŠŸèƒ½ï¼šæŒç»­æ£€æŸ¥è®¢å•æ”¯ä»˜çŠ¶æ€
   - ç”¨é€”ï¼šæ”¯ä»˜è½®è¯¢æ£€æŸ¥

3. **`payment_timeout_handler`** (ç¬¬ 966 è¡Œ)

   - åŠŸèƒ½ï¼šæ”¯ä»˜è¶…æ—¶å¤„ç†
   - ç”¨é€”ï¼šè®¢å•è¶…æ—¶å–æ¶ˆ

4. **`create_recharge_order`** (ç¬¬ 993 è¡Œ)

   - åŠŸèƒ½ï¼šåˆ›å»ºå……å€¼è®¢å•
   - ç”¨é€”ï¼šç”Ÿæˆæ”¯ä»˜é“¾æ¥

5. **`generate_payment_sign`** (ç¬¬ 3582 è¡Œ)

   - åŠŸèƒ½ï¼šç”Ÿæˆæ”¯ä»˜ç­¾å
   - ç”¨é€”ï¼šæ”¯ä»˜ API ç­¾å
   - **æ³¨æ„**ï¼šå·²åœ¨ web_app.py ä¸­è¿ç§»

6. **`create_payment_order`** (ç¬¬ 3588 è¡Œ)

   - åŠŸèƒ½ï¼šåˆ›å»ºæ”¯ä»˜è®¢å•
   - ç”¨é€”ï¼šè°ƒç”¨æ”¯ä»˜ API
   - **æ³¨æ„**ï¼šå·²åœ¨ web_app.py ä¸­è¿ç§»

7. **`extract_usdt_address_from_payment_url`** (ç¬¬ 3614 è¡Œ)

   - åŠŸèƒ½ï¼šä»æ”¯ä»˜é“¾æ¥é¡µé¢è§£æ USDT æ”¶æ¬¾åœ°å€
   - ç”¨é€”ï¼šæå–æ”¯ä»˜åœ°å€

8. **`send_recharge_notification`** (ç¬¬ 3644 è¡Œ)
   - åŠŸèƒ½ï¼šå‘é€å……å€¼æˆåŠŸé€šçŸ¥
   - ç”¨é€”ï¼šé€šçŸ¥ç”¨æˆ·å……å€¼æˆåŠŸ

### 3. âš ï¸ è¾…åŠ©å‡½æ•°ï¼ˆéƒ¨åˆ†ç¼ºå¤±ï¼‰

#### å·²è¿ç§» âœ…

- `get_main_account_id` - è·å–ä¸»è´¦å· ID
- `format_backup_account_display` - æ ¼å¼åŒ–å¤‡ç”¨å·æ˜¾ç¤º
- `link_account` - å…³è”è´¦å·
- `get_fallback_resource` - è·å–æ¡æ¼èµ„æº
- `get_main_keyboard` - è·å–ä¸»èœå•é”®ç›˜

#### æœªè¿ç§» âŒ

1. **`verify_group_link`** (ç¬¬ 585 è¡Œ)
   - åŠŸèƒ½ï¼šéªŒè¯ç¾¤é“¾æ¥ï¼Œæ£€æŸ¥æœºå™¨äººæ˜¯å¦åœ¨ç¾¤å†…ä¸”ä¸ºç®¡ç†å‘˜
   - ç”¨é€”ï¼šç»‘å®šç¾¤ç»„æ—¶éªŒè¯
   - **é‡è¦**ï¼šè¿™ä¸ªåº”è¯¥è¿ç§»åˆ° core_functions.py æˆ– bot_logic.py

### 4. âš ï¸ æ•°æ®åº“è¾…åŠ©å‡½æ•°ï¼ˆéƒ¨åˆ†ç¼ºå¤±ï¼‰

#### æœªè¿ç§» âŒ

1. **`upsert_member_group`** (ç¬¬ 5886 è¡Œ)

   - åŠŸèƒ½ï¼šæ’å…¥æˆ–æ›´æ–°ä¼šå‘˜ç¾¤ç»„
   - ç”¨é€”ï¼šåŒæ­¥ä¼šå‘˜ç¾¤ç»„æ•°æ®
   - **å»ºè®®**ï¼šè¿ç§»åˆ° database.py

2. **`sync_member_groups_from_members`** (ç¬¬ 5920 è¡Œ)

   - åŠŸèƒ½ï¼šä» members è¡¨åŒæ­¥ç¾¤ç»„åˆ° member_groups è¡¨
   - ç”¨é€”ï¼šæ•°æ®åŒæ­¥
   - **å»ºè®®**ï¼šè¿ç§»åˆ° database.py

3. **`upgrade_members_table`** (ç¬¬ 5835 è¡Œ)

   - åŠŸèƒ½ï¼šå‡çº§ members è¡¨ç»“æ„
   - ç”¨é€”ï¼šæ•°æ®åº“è¿ç§»
   - **å»ºè®®**ï¼šè¿ç§»åˆ° database.py

4. **`upgrade_member_groups_table`** (ç¬¬ 5868 è¡Œ)

   - åŠŸèƒ½ï¼šå‡çº§ member_groups è¡¨ç»“æ„
   - ç”¨é€”ï¼šæ•°æ®åº“è¿ç§»
   - **å»ºè®®**ï¼šè¿ç§»åˆ° database.py

5. **`upgrade_broadcast_table`** (ç¬¬ 5937 è¡Œ)
   - åŠŸèƒ½ï¼šå‡çº§ broadcast_messages è¡¨ç»“æ„
   - ç”¨é€”ï¼šæ•°æ®åº“è¿ç§»
   - **å»ºè®®**ï¼šè¿ç§»åˆ° database.py

### 5. âš ï¸ Flask è·¯ç”±ï¼ˆå¤§éƒ¨åˆ†å·²è¿ç§»ï¼Œä½†éœ€ç¡®è®¤ï¼‰

#### å·²è¿ç§» âœ…

- åŸºç¡€è·¯ç”±ï¼ˆç™»å½•ã€ç™»å‡ºã€é¡µé¢è·¯ç”±ï¼‰
- æ”¯ä»˜å›è°ƒè·¯ç”±
- éƒ¨åˆ† API è·¯ç”±

#### éœ€è¦ç¡®è®¤ âš ï¸

- æ‰€æœ‰ `/api/*` è·¯ç”±æ˜¯å¦éƒ½å·²è¿ç§»åˆ° `web_app.py`
- `complete_all_features.py` å’Œ `missing_routes.py` çš„è·¯ç”±æ˜¯å¦å·²æ•´åˆ

## ğŸ¯ ä¼˜å…ˆçº§å»ºè®®

### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆå¿…é¡»è¿ç§»ï¼‰

1. **`message_handler`** - æç°æµç¨‹çš„å…³é”®éƒ¨åˆ†
2. **`group_welcome_handler`** - è‡ªåŠ¨æ³¨å†ŒåŠŸèƒ½
3. **`verify_group_link`** - ç¾¤ç»„éªŒè¯åŠŸèƒ½
4. **æ”¯ä»˜ç›¸å…³å‡½æ•°** - å……å€¼åŠŸèƒ½çš„æ ¸å¿ƒ

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆå»ºè®®è¿ç§»ï¼‰

1. æ‰€æœ‰ç”¨æˆ·äº¤äº’çš„äº‹ä»¶å¤„ç†å™¨ï¼ˆview_fission, promote, resources ç­‰ï¼‰
2. æ‰€æœ‰ Callback å¤„ç†å™¨
3. æ•°æ®åº“è¾…åŠ©å‡½æ•°

### ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰è¿ç§»ï¼‰

1. `/test_link` - è°ƒè¯•å‘½ä»¤
2. `/myid` - æŸ¥çœ‹ ID å‘½ä»¤
3. `/link` - è´¦å·å…³è”å‘½ä»¤ï¼ˆå·²æœ‰å…¶ä»–æ–¹å¼å®ç°ï¼‰

## ğŸ“ è¿ç§»å»ºè®®

1. **ç«‹å³è¿ç§»**ï¼š

   - `message_handler` â†’ `bot_logic.py`
   - `group_welcome_handler` â†’ `bot_logic.py`
   - `verify_group_link` â†’ `core_functions.py` æˆ– `bot_logic.py`
   - æ”¯ä»˜ç›¸å…³å‡½æ•° â†’ `bot_logic.py` æˆ–æ–°å»º `payment.py`

2. **é€æ­¥è¿ç§»**ï¼š

   - å…¶ä»–äº‹ä»¶å¤„ç†å™¨ â†’ `bot_logic.py`
   - æ•°æ®åº“è¾…åŠ©å‡½æ•° â†’ `database.py`

3. **æµ‹è¯•éªŒè¯**ï¼š
   - è¿ç§»åæµ‹è¯•æç°åŠŸèƒ½
   - æµ‹è¯•ç¾¤ç»„ç»‘å®šåŠŸèƒ½
   - æµ‹è¯•å……å€¼åŠŸèƒ½
   - æµ‹è¯•è‡ªåŠ¨æ³¨å†ŒåŠŸèƒ½
