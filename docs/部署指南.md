# 🤖 裂变推广机器人系统 - 完整部署指南

## 📋 目录

1. [系统概述](#系统概述)
2. [环境要求](#环境要求)
3. [部署步骤](#部署步骤)
4. [配置说明](#配置说明)
5. [启动与停止](#启动与停止)
6. [常见问题](#常见问题)
7. [维护与备份](#维护与备份)

---

## 📖 系统概述

这是一个基于 **Telegram Bot** 和 **Flask Web 后台** 的裂变推广系统，主要功能包括：

- ✅ 10 层裂变推广系统
- ✅ VIP 会员自动激活
- ✅ USDT 充值提现
- ✅ 行业资源分类管理
- ✅ 多客服系统
- ✅ 群验证功能
- ✅ Web 管理后台
- ✅ 数据统计报表
- ✅ 定时群发功能

**技术栈：**

- Python 3.x
- Telethon (Telegram Bot 框架)
- Flask (Web 框架)
- SQLite3 (数据库)
- Tailwind CSS (前端样式)

---

## 🔧 环境要求

### 服务器要求

- **操作系统**: Linux (推荐 Ubuntu 20.04+ / CentOS 7+)
- **Python 版本**: Python 3.7 或更高版本
- **内存**: 至少 512MB RAM
- **磁盘空间**: 至少 1GB 可用空间
- **网络**: 能够访问 Telegram API (可能需要代理)

### 必需软件

- Python 3.7+
- pip (Python 包管理器)
- Git (可选，用于代码管理)

---

## 🚀 部署步骤

### 第一步：准备服务器环境

#### 1.1 更新系统

```bash
# Ubuntu/Debian
sudo apt update && sudo apt upgrade -y

# CentOS/RHEL
sudo yum update -y
```

#### 1.2 安装 Python 3 和 pip

```bash
# Ubuntu/Debian
sudo apt install python3 python3-pip -y

# CentOS/RHEL
sudo yum install python3 python3-pip -y

# 验证安装
python3 --version
pip3 --version
```

#### 1.3 创建项目目录

```bash
# 创建项目目录（根据你的实际路径调整）
sudo mkdir -p /www/wwwroot/154.201.68.178:5051
sudo chown -R $USER:$USER /www/wwwroot/154.201.68.178:5051
cd /www/wwwroot/154.201.68.178:5051
```

---

### 第二步：上传项目文件

#### 方式一：使用 Git (推荐)

```bash
# 如果有Git仓库
git clone <your-repo-url> /www/wwwroot/154.201.68.178:5051
cd /www/wwwroot/154.201.68.178:5051
```

#### 方式二：使用 SCP/FTP

```bash
# 从本地使用SCP上传
scp -r /本地项目路径/* user@服务器IP:/www/wwwroot/154.201.68.178:5051/
```

#### 方式三：直接编辑

在服务器上直接创建和编辑文件

---

### 第三步：安装 Python 依赖

```bash
cd /www/wwwroot/154.201.68.178:5051

# 安装依赖包
pip3 install -r requirements.txt

# 如果 requirements.txt 不完整，手动安装所有依赖
pip3 install flask==2.3.0 \
            telethon==1.28.5 \
            pysocks==1.7.1 \
            requests==2.31.0 \
            werkzeug==2.3.0 \
            flask-login \
            qrcode[pil] \
            Pillow

# 如果网络较慢，可以使用国内镜像源
pip3 install -i https://pypi.tuna.tsinghua.edu.cn/simple -r requirements.txt
```

**验证安装：**

```bash
python3 -c "import flask, telethon, qrcode; print('✅ 所有依赖安装成功')"
```

---

### 第四步：配置 Telegram Bot

#### 4.1 获取 Telegram API 凭证

1. 访问 https://my.telegram.org/apps
2. 使用你的 Telegram 账号登录
3. 创建新应用，获取：
   - **API ID**
   - **API Hash**

#### 4.2 创建 Telegram Bot

1. 在 Telegram 中搜索 `@BotFather`
2. 发送 `/newbot` 创建新机器人
3. 按提示设置机器人名称和用户名
4. 获取 **Bot Token** (格式: `123456789:ABCdefGHIjklMNOpqrsTUVwxyz`)

#### 4.3 配置项目文件

编辑 `a.py` 文件，修改以下配置：

```python
# 第 33-35 行：Telegram API 配置
API_ID = 21332425  # 替换为你的 API ID
API_HASH = 'f5d0cddc784e3a7a09ea9714ed01f238'  # 替换为你的 API Hash
BOT_TOKEN = '8282974213:AAEISGP5ijUbJSBMA9N5eoygWjAB266-1UE'  # 替换为你的 Bot Token

# 第 38 行：管理员ID列表
ADMIN_IDS = [7935612165]  # 替换为你的 Telegram 用户ID（可通过 /myid 命令获取）
```

**如何获取你的 Telegram 用户 ID：**

- 在 Telegram 中搜索 `@userinfobot`
- 发送任意消息，机器人会返回你的用户 ID

---

### 第五步：配置代理（如需要）

如果你的服务器无法直接访问 Telegram API，需要配置代理：

编辑 `a.py` 文件：

```python
# 第 429 行：代理配置
USE_PROXY = True  # 如果需要代理，改为 True
if USE_PROXY:
    proxy = (socks.SOCKS5, '127.0.0.1', 7897)  # 修改为你的代理地址和端口
    bot = TelegramClient('bot', API_ID, API_HASH, proxy=proxy).start(bot_token=BOT_TOKEN)
else:
    bot = TelegramClient(MemorySession(), API_ID, API_HASH).start(bot_token=BOT_TOKEN)
```

**代理类型支持：**

- SOCKS5 代理
- HTTP 代理（需要修改代码）

如果服务器可以直接访问 Telegram，保持 `USE_PROXY = False` 即可。

---

### 第六步：配置支付系统（可选）

编辑 `a.py` 文件，找到支付配置部分（约第 3125-3133 行）：

```python
PAYMENT_CONFIG = {
    'api_url': 'https://usdt.qxzy7888.org/pay/',  # 支付API地址
    'partner_id': '15',  # 合作伙伴ID
    'key': '5c9dd0b054b184f964',  # API密钥
    'notify_url': 'http://154.201.68.178:5051:5051/api/payment/notify',  # 回调地址
    'return_url': 'http://154.201.68.178:5051:5051/payment/success',  # 返回地址
    'pay_type': 'trc20',  # 支付类型
    'version': '1.0'
}
```

**重要：** 修改 `notify_url` 和 `return_url` 为你的实际域名。

---

### 第七步：配置 Web 服务器

#### 7.1 修改 Flask 配置

编辑 `a.py` 文件，找到 Flask 配置（约第 3113-3117 行）：

```python
app = Flask(__name__)
app.secret_key = 'fission-bot-secret-key-2025'  # ⚠️ 请修改为随机字符串
app.config['REMEMBER_COOKIE_DURATION'] = timedelta(days=90)
app.config['TEMPLATES_AUTO_RELOAD'] = True
```

**生成安全的 secret_key：**

```bash
python3 -c "import secrets; print(secrets.token_hex(32))"
```

#### 7.2 配置端口和域名

编辑 `a.py` 文件，找到 Web 服务器启动部分（约第 4979 行）：

```python
def start_web_server():
    """在后台线程启动Web服务器"""
    app.run(debug=False, host='0.0.0.0', port=5051, use_reloader=False)
```

默认端口是 **5051**，如需修改请更改 `port=5051`。

#### 7.3 配置 Nginx 反向代理（推荐）

如果使用 Nginx 作为反向代理，创建配置文件：

```bash
sudo nano /etc/nginx/sites-available/154.201.68.178:5051
```

添加以下配置：

```nginx
server {
    listen 80;
    server_name 154.201.68.178:5051;

    location / {
        proxy_pass http://127.0.0.1:5051;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket 支持（如果需要）
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

启用配置：

```bash
sudo ln -s /etc/nginx/sites-available/154.201.68.178:5051 /etc/nginx/sites-enabled/
sudo nginx -t  # 测试配置
sudo systemctl reload nginx  # 重载配置
```

#### 7.4 配置 SSL/HTTPS（推荐）

使用 Let's Encrypt 免费 SSL 证书：

```bash
# 安装 Certbot
sudo apt install certbot python3-certbot-nginx -y

# 获取证书
sudo certbot --nginx -d 154.201.68.178:5051

# 自动续期
sudo certbot renew --dry-run
```

---

### 第八步：初始化数据库

首次运行会自动创建数据库，但你可以手动初始化：

```bash
cd /www/wwwroot/154.201.68.178:5051
python3 -c "from a import init_db; init_db(); print('✅ 数据库初始化完成')"
```

数据库文件 `bot.db` 会自动创建在项目根目录。

---

### 第九步：设置文件权限

```bash
cd /www/wwwroot/154.201.68.178:5051

# 设置脚本执行权限
chmod +x start.sh stop.sh

# 设置数据库文件权限（确保可读写）
touch bot.db
chmod 644 bot.db

# 设置日志文件权限
touch bot.log
chmod 644 bot.log
```

---

### 第十步：测试运行

#### 10.1 手动测试

```bash
cd /www/wwwroot/154.201.68.178:5051
python3 a.py
```

如果看到以下输出，说明启动成功：

```
============================================================
🤖 裂变推广机器人启动中...
============================================================

📊 初始化数据库...
✅ 数据库初始化完成

🌐 启动Web管理后台...
✅ Web管理后台已启动

🚀 Telegram机器人已启动

============================================================
📱 访问地址：
   服务器访问：http://154.201.68.178:5051
   IP访问：http://118.107.0.247:5051
============================================================
```

按 `Ctrl+C` 停止测试。

#### 10.2 测试 Web 后台

1. 在浏览器访问：`http://你的服务器IP:5051` 或 `http://你的域名:5051`
2. 使用默认账号登录：
   - 用户名：`admin`
   - 密码：`admin`
3. **⚠️ 首次登录后请立即修改密码！**

#### 10.3 测试 Telegram Bot

1. 在 Telegram 中搜索你的机器人
2. 发送 `/start` 命令
3. 如果机器人有响应，说明配置成功

---

## 🎯 启动与停止

### 使用启动脚本（推荐）

#### 启动服务

```bash
cd /www/wwwroot/154.201.68.178:5051
./start.sh
```

#### 停止服务

```bash
cd /www/wwwroot/154.201.68.178:5051
./stop.sh
```

#### 查看运行状态

```bash
# 查看进程
ps aux | grep "python3 a.py"

# 查看日志
tail -f bot.log

# 查看进程ID
cat bot.pid
```

### 使用 systemd 服务（推荐生产环境）

创建 systemd 服务文件：

```bash
sudo nano /etc/systemd/system/telegram-bot.service
```

添加以下内容：

```ini
[Unit]
Description=Telegram Fission Bot
After=network.target

[Service]
Type=simple
User=你的用户名
WorkingDirectory=/www/wwwroot/154.201.68.178:5051
ExecStart=/usr/bin/python3 /www/wwwroot/154.201.68.178:5051/a.py
Restart=always
RestartSec=10
StandardOutput=append:/www/wwwroot/154.201.68.178:5051/bot.log
StandardError=append:/www/wwwroot/154.201.68.178:5051/bot.log

[Install]
WantedBy=multi-user.target
```

启用并启动服务：

```bash
# 重新加载 systemd
sudo systemctl daemon-reload

# 启用服务（开机自启）
sudo systemctl enable telegram-bot

# 启动服务
sudo systemctl start telegram-bot

# 查看状态
sudo systemctl status telegram-bot

# 查看日志
sudo journalctl -u telegram-bot -f
```

---

## ⚙️ 配置说明

### 系统设置

可以通过 Web 管理后台修改以下设置：

- **层数设置** (`level_count`): 默认 10 层
- **每层奖励** (`level_reward`): 默认 1U
- **VIP 价格** (`vip_price`): 默认 10U
- **提现门槛** (`withdraw_threshold`): 默认 50U
- **USDT 地址** (`usdt_address`): 充值地址
- **客服文本** (`support_text`): 客服消息内容

访问路径：`http://你的域名:5051/settings`

### 数据库配置

数据库使用 SQLite3，文件位置：`/www/wwwroot/154.201.68.178:5051/bot.db`

主要数据表：

- `members` - 会员信息
- `withdrawals` - 提现记录
- `system_config` - 系统配置
- `admin_users` - 管理员账号
- `resources` - 行业资源
- `customer_service` - 客服信息

### 文件结构

```
154.201.68.178:5051/
├── a.py                    # 主程序文件
├── bot.db                  # SQLite数据库
├── bot.log                 # 运行日志
├── bot.pid                 # 进程ID文件
├── bot.session             # Telegram会话文件
├── requirements.txt        # Python依赖列表
├── start.sh               # 启动脚本
├── stop.sh                # 停止脚本
├── core_functions.py      # 核心功能模块
├── bot_commands_addon.py  # 命令扩展模块
├── templates/             # HTML模板目录
│   ├── index.html        # 会员管理
│   ├── statistics.html   # 统计报表
│   ├── withdrawals.html  # 提现审核
│   └── ...
├── static/                # 静态文件目录
│   ├── favicon.jpg
│   └── uploads/
└── usdt_qr.png           # USDT二维码
```

---

## ❓ 常见问题

### 1. 机器人无法启动

**问题：** 启动时提示 `ConnectionError` 或 `TimeoutError`

**解决方案：**

- 检查网络连接
- 如果在中国大陆，需要配置代理（设置 `USE_PROXY = True`）
- 检查 API_ID、API_HASH、BOT_TOKEN 是否正确
- 查看 `bot.log` 日志文件获取详细错误信息

### 2. Web 后台无法访问

**问题：** 浏览器无法打开管理后台

**解决方案：**

- 检查防火墙是否开放 5051 端口：

  ```bash
  # Ubuntu/Debian
  sudo ufw allow 5051/tcp

  # CentOS/RHEL
  sudo firewall-cmd --add-port=5051/tcp --permanent
  sudo firewall-cmd --reload
  ```

- 检查进程是否运行：`ps aux | grep "python3 a.py"`
- 检查日志：`tail -f bot.log`

### 3. 数据库锁定错误

**问题：** 提示 `database is locked`

**解决方案：**

- 确保只有一个进程在运行
- 检查是否有其他程序正在访问数据库
- 重启服务：`./stop.sh && ./start.sh`

### 4. 依赖安装失败

**问题：** `pip install` 失败

**解决方案：**

- 使用国内镜像源：
  ```bash
  pip3 install -i https://pypi.tuna.tsinghua.edu.cn/simple -r requirements.txt
  ```
- 升级 pip：`pip3 install --upgrade pip`
- 使用虚拟环境（推荐）

### 5. 登录后台提示密码错误

**问题：** 无法使用默认账号登录

**解决方案：**

- 默认账号：`admin` / `admin`
- 如果忘记密码，可以重置：
  ```bash
  python3 -c "
  from werkzeug.security import generate_password_hash
  print('新密码哈希:', generate_password_hash('新密码'))
  "
  ```
  然后更新数据库中的 `password_hash` 字段

### 6. Telegram 消息发送失败

**问题：** 机器人无法发送消息

**解决方案：**

- 检查机器人是否被用户阻止
- 检查机器人是否有发送消息的权限
- 查看日志获取详细错误信息

### 7. 支付回调失败

**问题：** 充值后余额未更新

**解决方案：**

- 检查 `notify_url` 配置是否正确
- 确保服务器可以接收外部请求
- 检查支付 API 配置是否正确
- 查看日志中的支付回调记录

---

## 🔄 维护与备份

### 定期备份

#### 备份数据库

```bash
# 创建备份目录
mkdir -p /backup/telegram-bot

# 备份数据库（每天执行）
cp /www/wwwroot/154.201.68.178:5051/bot.db /backup/telegram-bot/bot_$(date +%Y%m%d).db

# 只保留最近7天的备份
find /backup/telegram-bot -name "bot_*.db" -mtime +7 -delete
```

#### 设置自动备份（Crontab）

```bash
# 编辑 crontab
crontab -e

# 添加以下行（每天凌晨2点备份）
0 2 * * * cp /www/wwwroot/154.201.68.178:5051/bot.db /backup/telegram-bot/bot_$(date +\%Y\%m\%d).db
```

### 日志管理

```bash
# 查看实时日志
tail -f /www/wwwroot/154.201.68.178:5051/bot.log

# 查看最近100行
tail -n 100 /www/wwwroot/154.201.68.178:5051/bot.log

# 清空日志（谨慎操作）
> /www/wwwroot/154.201.68.178:5051/bot.log

# 日志轮转（防止日志文件过大）
# 可以配置 logrotate
```

### 更新代码

```bash
cd /www/wwwroot/154.201.68.178:5051

# 停止服务
./stop.sh

# 备份当前版本
cp -r . ../liebian_backup_$(date +%Y%m%d)

# 更新代码（根据你的方式）
git pull  # 如果使用Git
# 或手动上传新文件

# 安装新依赖（如果有）
pip3 install -r requirements.txt

# 启动服务
./start.sh
```

### 监控服务

```bash
# 检查服务是否运行
ps aux | grep "python3 a.py"

# 检查端口是否监听
netstat -tlnp | grep 5051

# 检查系统资源
top
htop  # 如果安装了
```

---

## 📞 技术支持

如果遇到问题：

1. 查看日志文件：`bot.log`
2. 检查配置文件是否正确
3. 确认所有依赖已正确安装
4. 验证网络连接和代理配置

---

## ✅ 部署检查清单

部署完成后，请确认以下项目：

- [ ] Python 3.7+ 已安装
- [ ] 所有依赖包已安装
- [ ] API_ID、API_HASH、BOT_TOKEN 已配置
- [ ] 管理员 ID 已设置
- [ ] 代理配置正确（如需要）
- [ ] 数据库已初始化
- [ ] Web 后台可以访问
- [ ] Telegram 机器人可以响应
- [ ] 防火墙端口已开放
- [ ] 服务可以正常启动和停止
- [ ] 已设置自动备份
- [ ] 已修改默认管理员密码

---

## 🎉 部署完成

恭喜！你的裂变推广机器人系统已经部署完成。

**访问地址：**

- Web 管理后台：`http://你的域名:5051` 或 `http://你的IP:5051`
- 默认账号：`admin` / `admin`（请立即修改密码）

**下一步：**

1. 登录管理后台修改默认密码
2. 配置系统设置（层数、奖励、VIP 价格等）
3. 设置 USDT 充值地址
4. 配置客服信息
5. 测试各项功能

祝你使用愉快！🚀
