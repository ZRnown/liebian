{% extends "base.html" %}

{% block title %}ç³»ç»Ÿé…ç½®ä¸­å¿ƒ{% endblock %}

{% block content %}
<main class="px-6 py-8 fade-in-up">
        
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-8">
            <div>
                <h2 class="text-2xl font-bold text-slate-900 tracking-tight">å‚æ•°è®¾ç½®</h2>
                <p class="text-slate-500 mt-1">ç®¡ç†æœºå™¨äººè£‚å˜è§„åˆ™ã€è´¢åŠ¡å‚æ•°åŠåŸºç¡€æœåŠ¡ä¿¡æ¯ã€‚</p>
            </div>
            <button onclick="loadSettings()" class="group inline-flex items-center justify-center gap-2 px-5 py-2.5 bg-white border border-slate-200 text-sm font-medium rounded-xl text-slate-700 hover:border-brand-500 hover:text-brand-600 hover:shadow-md transition-all active:scale-95 focus:outline-none focus:ring-2 focus:ring-brand-500/20">
                <i class="ti ti-refresh group-hover:rotate-180 transition-transform duration-500"></i> 
                åˆ·æ–°æ•°æ®
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 mb-6">
            
            <div class="bg-white rounded-2xl p-5 border border-slate-100 shadow-soft hover:shadow-hover transition-all duration-300">
                <div class="flex justify-between items-start mb-4">
                    <div class="p-2 bg-blue-50 text-blue-600 rounded-lg">
                        <i class="ti ti-sitemap text-xl"></i>
                    </div>
                    <span class="text-xs font-semibold px-2 py-1 bg-slate-50 text-slate-500 rounded-md">å±‚çº§</span>
                </div>
                <div class="mb-4">
                    <p class="text-sm text-slate-500 font-medium">æ¨å¹¿å±‚æ•°è®¾ç½®</p>
                    <div class="flex items-baseline gap-1 mt-1">
                        <h3 id="current-levels" class="text-3xl font-bold text-slate-900">-</h3>
                        <span class="text-sm text-slate-400">Level</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <input type="number" id="input-levels" min="1" max="100" class="w-full bg-slate-50 text-sm border-0 rounded-lg px-3 py-2 ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all outline-none" placeholder="æ–°æ•°å€¼">
                    <button onclick="updateLevels()" class="px-3 py-2 bg-slate-900 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        <i class="ti ti-check"></i>
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-2xl p-5 border border-slate-100 shadow-soft hover:shadow-hover transition-all duration-300">
                <div class="flex justify-between items-start mb-4">
                    <div class="p-2 bg-green-50 text-green-600 rounded-lg">
                        <i class="ti ti-coins text-xl"></i>
                    </div>
                    <span class="text-xs font-semibold px-2 py-1 bg-slate-50 text-slate-500 rounded-md">å¥–åŠ±</span>
                </div>
                <div class="mb-4">
                    <p class="text-sm text-slate-500 font-medium">æ¯å±‚è¿”åˆ©é‡‘é¢</p>
                    <div class="flex items-baseline gap-1 mt-1">
                        <h3 id="current-reward" class="text-3xl font-bold text-slate-900">-</h3>
                        <span class="text-sm text-slate-400">USDT</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <input type="number" id="input-reward" min="0" step="0.1" class="w-full bg-slate-50 text-sm border-0 rounded-lg px-3 py-2 ring-1 ring-slate-200 focus:ring-2 focus:ring-green-500 focus:bg-white transition-all outline-none" placeholder="æ–°æ•°å€¼">
                    <button onclick="updateReward()" class="px-3 py-2 bg-slate-900 text-white rounded-lg hover:bg-green-600 transition-colors">
                        <i class="ti ti-check"></i>
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-2xl p-5 border border-slate-100 shadow-soft hover:shadow-hover transition-all duration-300">
                <div class="flex justify-between items-start mb-4">
                    <div class="p-2 bg-amber-50 text-amber-600 rounded-lg">
                        <i class="ti ti-crown text-xl"></i>
                    </div>
                    <span class="text-xs font-semibold px-2 py-1 bg-slate-50 text-slate-500 rounded-md">å®šä»·</span>
                </div>
                <div class="mb-4">
                    <p class="text-sm text-slate-500 font-medium">VIP è´­ä¹°ä»·æ ¼</p>
                    <div class="flex items-baseline gap-1 mt-1">
                        <h3 id="current-vip-price" class="text-3xl font-bold text-slate-900">-</h3>
                        <span class="text-sm text-slate-400">USDT</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <input type="number" id="input-vip-price" min="0" step="0.1" class="w-full bg-slate-50 text-sm border-0 rounded-lg px-3 py-2 ring-1 ring-slate-200 focus:ring-2 focus:ring-amber-500 focus:bg-white transition-all outline-none" placeholder="æ–°æ•°å€¼">
                    <button onclick="updateVipPrice()" class="px-3 py-2 bg-slate-900 text-white rounded-lg hover:bg-amber-600 transition-colors">
                        <i class="ti ti-check"></i>
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-2xl p-5 border border-slate-100 shadow-soft hover:shadow-hover transition-all duration-300">
                <div class="flex justify-between items-start mb-4">
                    <div class="p-2 bg-purple-50 text-purple-600 rounded-lg">
                        <i class="ti ti-wallet text-xl"></i>
                    </div>
                    <span class="text-xs font-semibold px-2 py-1 bg-slate-50 text-slate-500 rounded-md">é£æ§</span>
                </div>
                <div class="mb-4">
                    <p class="text-sm text-slate-500 font-medium">æœ€ä½æç°é—¨æ§›</p>
                    <div class="flex items-baseline gap-1 mt-1">
                        <h3 id="current-threshold" class="text-3xl font-bold text-slate-900">-</h3>
                        <span class="text-sm text-slate-400">USDT</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <input type="number" id="input-threshold" min="0" step="0.1" class="w-full bg-slate-50 text-sm border-0 rounded-lg px-3 py-2 ring-1 ring-slate-200 focus:ring-2 focus:ring-purple-500 focus:bg-white transition-all outline-none" placeholder="æ–°æ•°å€¼">
                    <button onclick="updateThreshold()" class="px-3 py-2 bg-slate-900 text-white rounded-lg hover:bg-purple-600 transition-colors">
                        <i class="ti ti-check"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <div class="lg:col-span-2 bg-white rounded-2xl border border-slate-100 shadow-soft p-6">
                <div class="flex items-center gap-3 mb-6">
                    <div class="h-10 w-10 rounded-full bg-brand-50 flex items-center justify-center text-brand-600">
                        <i class="ti ti-currency-tether text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-base font-bold text-slate-900">æ”¶æ¬¾é’±åŒ…é…ç½®</h3>
                        <p class="text-sm text-slate-500">USDT-TRC20 æ”¶æ¬¾åœ°å€ç®¡ç†</p>
                    </div>
                </div>
                
                <div class="bg-slate-50 rounded-xl p-4 border border-slate-100 mb-5 relative group">
                    <span class="text-xs font-medium text-slate-400 block mb-1">å½“å‰ç”Ÿæ•ˆåœ°å€</span>
                    <p id="current-address" class="font-mono text-sm text-slate-800 break-all pr-12">-</p>
                    <button onclick="copyAddress()" class="absolute right-3 top-1/2 -translate-y-1/2 p-2 text-slate-400 hover:text-brand-600 hover:bg-white rounded-lg transition-all opacity-0 group-hover:opacity-100">
                        <i class="ti ti-copy text-lg"></i>
                    </button>
                </div>

                <div class="flex flex-col sm:flex-row gap-3">
                    <div class="relative flex-1">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="ti ti-link text-slate-400"></i>
                        </div>
                        <input type="text" id="input-address" placeholder="T..." 
                               class="pl-10 w-full bg-white border-slate-200 rounded-xl py-2.5 text-sm ring-1 ring-slate-200 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition-all outline-none"
                        >
                    </div>
                    <button onclick="updateAddress()" class="inline-flex justify-center items-center gap-2 px-6 py-2.5 bg-brand-600 hover:bg-brand-700 text-white text-sm font-medium rounded-xl transition-all shadow-lg shadow-brand-500/30 active:scale-95">
                        <i class="ti ti-device-floppy"></i> ä¿å­˜åœ°å€
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-2xl border border-slate-100 shadow-soft p-6 flex flex-col">
                <div class="flex items-center gap-3 mb-6">
                    <div class="h-10 w-10 rounded-full bg-pink-50 flex items-center justify-center text-pink-600">
                        <i class="ti ti-message-chatbot text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-base font-bold text-slate-900">å®¢æœæ–‡æ¡ˆ</h3>
                        <p class="text-sm text-slate-500">æœºå™¨äººå›å¤çš„è”ç³»æ–¹å¼</p>
                    </div>
                </div>
                
                <div class="flex-1 min-h-[100px] mb-4">
                    <textarea id="input-service" rows="4" placeholder="è¯·è¾“å…¥å®¢æœè”ç³»æ–¹å¼..." 
                              class="w-full h-full bg-slate-50 border-0 ring-1 ring-slate-200 rounded-xl p-4 text-sm focus:ring-2 focus:ring-pink-500 focus:bg-white transition-all resize-none outline-none"></textarea>
                </div>
                
                <div class="flex justify-between items-center">
                    <div class="text-xs text-slate-400 truncate max-w-[150px]">
                        å½“å‰: <span id="current-service" class="font-medium text-slate-600">-</span>
                    </div>
                    <button onclick="updateService()" class="px-4 py-2 bg-white border border-slate-200 text-slate-700 hover:text-pink-600 hover:border-pink-200 rounded-lg text-sm font-medium transition-all">
                        æ›´æ–°æ–‡æ¡ˆ
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-2xl border border-slate-100 shadow-soft p-6 flex flex-col">
                <div class="flex items-center gap-3 mb-6">
                    <div class="h-10 w-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-600">
                        <i class="ti ti-lock text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-base font-bold text-slate-900">å®‰å…¨è®¾ç½®</h3>
                        <p class="text-sm text-slate-500">ä¿®æ”¹ç®¡ç†å‘˜å¯†ç </p>
                    </div>
                </div>
                
                <div class="space-y-3 flex-1">
                    <input type="password" id="old-password" placeholder="å½“å‰å¯†ç " 
                           class="w-full bg-slate-50 border-0 ring-1 ring-slate-200 rounded-xl px-4 py-2.5 text-sm focus:ring-2 focus:ring-slate-500 focus:bg-white transition-all outline-none">
                    <input type="password" id="new-password" placeholder="æ–°å¯†ç " 
                           class="w-full bg-slate-50 border-0 ring-1 ring-slate-200 rounded-xl px-4 py-2.5 text-sm focus:ring-2 focus:ring-slate-500 focus:bg-white transition-all outline-none">
                </div>
                
                <div class="flex justify-end mt-4">
                    <button onclick="changePassword()" class="px-4 py-2 bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 rounded-lg text-sm font-medium transition-all">
                        ç¡®è®¤ä¿®æ”¹
                    </button>
                </div>
            </div>
        </div>

        <!-- æ¡æ¼è´¦å·ç®¡ç† -->
        <div class="mt-6 bg-white rounded-2xl border border-slate-100 shadow-soft p-6">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-full bg-yellow-50 flex items-center justify-center text-yellow-600">
                        <i class="ti ti-trophy text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-base font-bold text-slate-900">æ¡æ¼è´¦å·ç®¡ç†</h3>
                        <p class="text-sm text-slate-500">ç®¡ç†10ä¸ªé¢„è®¾æ¡æ¼è´¦å·</p>
                    </div>
                </div>
                <a href="/fallback-accounts" class="px-4 py-2 bg-slate-100 hover:bg-yellow-100 text-slate-700 hover:text-yellow-700 rounded-lg text-sm font-medium transition-all">
                    æŸ¥çœ‹è¯¦æƒ…
                </a>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-slate-50 text-slate-600">
                        <tr>
                            <th class="px-4 py-3 text-left rounded-tl-lg">åºå·</th>
                            <th class="px-4 py-3 text-left">è´¦å·å</th>
                            <th class="px-4 py-3 text-left">Telegram ID</th>
                            <th class="px-4 py-3 text-left">ä½™é¢</th>
                            <th class="px-4 py-3 text-left rounded-tr-lg">çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody id="fallback-accounts-list" class="divide-y divide-slate-100">
                        <!-- åŠ¨æ€åŠ è½½ -->
                    </tbody>
                </table>
            </div>
        </div>

            <div class="flex items-center gap-3 mb-6">
                <div class="h-10 w-10 rounded-full bg-orange-50 flex items-center justify-center text-orange-600">
                    <i class="ti ti-speakerphone text-xl"></i>
                </div>
                <div>
                    <h3 class="text-base font-bold text-slate-900">ç½®é¡¶å¹¿å‘Šè®¾ç½®</h3>
                    <p class="text-sm text-slate-500">è®¾ç½®ç¾¤ç»„ç½®é¡¶å¹¿å‘Šå†…å®¹</p>
                </div>
            </div>
            <textarea id="pinned-ad-content" rows="4" placeholder="è¾“å…¥ç½®é¡¶å¹¿å‘Šå†…å®¹..." 
                      class="w-full bg-slate-50 border-0 ring-1 ring-slate-200 rounded-xl p-4 text-sm focus:ring-2 focus:ring-orange-500 focus:bg-white transition-all resize-none outline-none mb-4"></textarea>
            <p class="text-xs text-slate-400 mb-4">ğŸ’¡ ç‚¹å‡»å‘å¸ƒåï¼Œæœºå™¨äººä¼šåœ¨æ‰€æœ‰ä¼šå‘˜ç¾¤å‘é€å¹¿å‘Šå¹¶å°è¯•ç½®é¡¶ï¼ˆéœ€è¦æœºå™¨äººæ˜¯ç¾¤ç®¡ç†å‘˜ï¼‰</p>
            <div class="flex justify-end">
                <button onclick="updatePinnedAd()" class="px-6 py-2.5 bg-orange-600 hover:bg-orange-700 text-white text-sm font-medium rounded-xl transition-all flex items-center gap-2">
                    <i class="ti ti-send"></i> å‘å¸ƒå¹¶ç½®é¡¶
                </button>
            </div>
        </div>

        <!-- ç¾¤æ¬¢è¿è¯­è®¾ç½® -->
        <div class="mt-6 bg-white rounded-2xl border border-slate-100 shadow-soft p-6">
            <div class="flex items-center gap-3 mb-6">
                <div class="h-10 w-10 rounded-full bg-green-50 flex items-center justify-center text-green-600">
                    <i class="ti ti-message-circle text-xl"></i>
                </div>
                <div>
                    <h3 class="text-base font-bold text-slate-900">ç¾¤æ¬¢è¿è¯­è®¾ç½®</h3>
                    <p class="text-sm text-slate-500">æ–°æˆå‘˜åŠ å…¥ç¾¤ç»„æ—¶çš„æ¬¢è¿æ¶ˆæ¯</p>
                </div>
            </div>
            <textarea id="welcome-message-content" rows="5" placeholder="è¾“å…¥æ¬¢è¿è¯­å†…å®¹..." 
                      class="w-full bg-slate-50 border-0 ring-1 ring-slate-200 rounded-xl p-4 text-sm focus:ring-2 focus:ring-green-500 focus:bg-white transition-all resize-none outline-none mb-4"></textarea>
            <div class="flex justify-end">
                <button onclick="updateWelcomeMessage()" class="px-6 py-2.5 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-xl transition-all">
                    <i class="ti ti-device-floppy mr-1"></i> ä¿å­˜æ¬¢è¿è¯­
                </button>
            </div>
        </div>

        <div class="mt-8 border-t border-slate-200 pt-8">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div class="flex flex-col gap-1">
                    <span class="text-slate-400 text-xs uppercase tracking-wider font-semibold">Database</span>
                    <span class="text-slate-700 font-mono flex items-center gap-2"><i class="ti ti-database text-brand-500"></i> SQLite</span>
                </div>
                <div class="flex flex-col gap-1">
                    <span class="text-slate-400 text-xs uppercase tracking-wider font-semibold">Backend</span>
                    <span class="text-slate-700 font-mono flex items-center gap-2"><i class="ti ti-brand-python text-brand-500"></i> Python Flask</span>
                </div>
                <div class="flex flex-col gap-1">
                    <span class="text-slate-400 text-xs uppercase tracking-wider font-semibold">Core</span>
                    <span class="text-slate-700 font-mono flex items-center gap-2"><i class="ti ti-robot text-brand-500"></i> Telethon</span>
                </div>
                <div class="flex flex-col gap-1">
                    <span class="text-slate-400 text-xs uppercase tracking-wider font-semibold">Last Synced</span>
                    <span id="update-time" class="text-slate-700 font-mono">-</span>
                </div>
            </div>
        </div>
    </main>





<script>
// æ˜¾ç¤ºæç¤ºæ¶ˆæ¯ (UIé€»è¾‘å¾®è°ƒï¼Œå¢åŠ åŠ¨ç”»ç±»æ§åˆ¶)
        function showToast(title, message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const titleEl = document.getElementById('toast-title');
            const messageEl = document.getElementById('toast-message');

            const icons = {
                success: '<div class="h-8 w-8 rounded-full bg-green-50 flex items-center justify-center"><i class="ti ti-check text-green-600"></i></div>',
                error: '<div class="h-8 w-8 rounded-full bg-red-50 flex items-center justify-center"><i class="ti ti-alert-triangle text-red-600"></i></div>',
                info: '<div class="h-8 w-8 rounded-full bg-blue-50 flex items-center justify-center"><i class="ti ti-info-circle text-blue-600"></i></div>'
            };

            icon.innerHTML = icons[type] || icons.info;
            titleEl.textContent = title;
            messageEl.textContent = message;

            // åŠ¨ç”»æ˜¾ç¤º
            toast.classList.remove('translate-x-full', 'opacity-0');
            
            // è‡ªåŠ¨å…³é—­
            if (window.toastTimeout) clearTimeout(window.toastTimeout);
            window.toastTimeout = setTimeout(hideToast, 4000);
        }

        function hideToast() {
            const toast = document.getElementById('toast');
            toast.classList.add('translate-x-full', 'opacity-0');
        }

        // --- ä»¥ä¸‹æ‰€æœ‰ä¸šåŠ¡é€»è¾‘å‡½æ•°ä¸åŸç‰ˆä¿æŒå®Œå…¨ä¸€è‡´ ---

        async function loadSettings() {
            try {
                const response = await fetch('/api/settings');
                const data = await response.json();

                if (data.success) {
                    const settings = data.settings;
                    document.getElementById('current-levels').textContent = settings.levels;
                    document.getElementById('current-reward').textContent = settings.reward_per_level;
                    document.getElementById('current-vip-price').textContent = settings.vip_price;
                    document.getElementById('current-threshold').textContent = settings.withdraw_threshold;
                    document.getElementById('current-address').textContent = settings.usdt_address || 'æœªè®¾ç½®';
                    document.getElementById('current-service').textContent = settings.service_text || 'æœªè®¾ç½®';
                    document.getElementById('update-time').textContent = new Date().toLocaleString('zh-CN');
                } else {
                    showToast('åŠ è½½å¤±è´¥', data.message || 'æ— æ³•åŠ è½½è®¾ç½®', 'error');
                }
            } catch (error) {
                // ä¸ºäº†æ¼”ç¤ºç•Œé¢æ•ˆæœï¼Œå¦‚æœåœ¨æœ¬åœ°æ‰“å¼€æ–‡ä»¶æ²¡æœ‰APIï¼Œä¼šæŠ¥é”™ï¼Œè¿™é‡Œä»…åšå®¹é”™
                console.error(error);
                showToast('æç¤º', 'æ­£åœ¨å°è¯•è¿æ¥API...', 'info');
            }
        }

        async function updateSetting(key, value, successMessage) {
            try {
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key, value })
                });
                const data = await response.json();

                if (data.success) {
                    showToast('æ“ä½œæˆåŠŸ', successMessage, 'success');
                    loadSettings();
                } else {
                    showToast('ä¿å­˜å¤±è´¥', data.message || 'æœªçŸ¥é”™è¯¯', 'error');
                }
            } catch (error) {
                showToast('ä¿å­˜å¤±è´¥', 'ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        }

        function updateLevels() {
            const value = parseInt(document.getElementById('input-levels').value);
            if (!value || value < 1) {
                showToast('è¾“å…¥é”™è¯¯', 'è¯·è¾“å…¥æœ‰æ•ˆçš„å±‚æ•°ï¼ˆ>=1ï¼‰', 'error');
                return;
            }
            updateSetting('levels', value, `å±‚æ•°å·²æ›´æ–°ä¸º ${value} å±‚`);
        }

        function updateReward() {
            const value = parseFloat(document.getElementById('input-reward').value);
            if (value === undefined || value < 0) {
                showToast('è¾“å…¥é”™è¯¯', 'è¯·è¾“å…¥æœ‰æ•ˆçš„è¿”åˆ©é‡‘é¢ï¼ˆ>=0ï¼‰', 'error');
                return;
            }
            updateSetting('reward_per_level', value, `æ¯å±‚è¿”åˆ©å·²æ›´æ–°ä¸º ${value} U`);
        }

        function updateVipPrice() {
            const value = parseFloat(document.getElementById('input-vip-price').value);
            if (value === undefined || value < 0) {
                showToast('è¾“å…¥é”™è¯¯', 'è¯·è¾“å…¥æœ‰æ•ˆçš„VIPä»·æ ¼ï¼ˆ>=0ï¼‰', 'error');
                return;
            }
            updateSetting('vip_price', value, `VIPä»·æ ¼å·²æ›´æ–°ä¸º ${value} U`);
        }

        function updateThreshold() {
            const value = parseFloat(document.getElementById('input-threshold').value);
            if (value === undefined || value < 0) {
                showToast('è¾“å…¥é”™è¯¯', 'è¯·è¾“å…¥æœ‰æ•ˆçš„æç°é—¨æ§›ï¼ˆ>=0ï¼‰', 'error');
                return;
            }
            updateSetting('withdraw_threshold', value, `æç°é—¨æ§›å·²æ›´æ–°ä¸º ${value} U`);
        }

        function updateAddress() {
            const value = document.getElementById('input-address').value.trim();
            if (!value) {
                showToast('è¾“å…¥é”™è¯¯', 'è¯·è¾“å…¥æœ‰æ•ˆçš„USDTåœ°å€', 'error');
                return;
            }
            updateSetting('usdt_address', value, 'USDTåœ°å€å·²æ›´æ–°');
        }

        function updateService() {
            const value = document.getElementById('input-service').value.trim();
            if (!value) {
                showToast('è¾“å…¥é”™è¯¯', 'è¯·è¾“å…¥å®¢æœä¿¡æ¯', 'error');
                return;
            }
            updateSetting('service_text', value, 'å®¢æœä¿¡æ¯å·²æ›´æ–°');
        }

        function copyAddress() {
            const address = document.getElementById('current-address').textContent;
            if (address && address !== '-' && address !== 'æœªè®¾ç½®') {
                navigator.clipboard.writeText(address).then(() => {
                    showToast('å¤åˆ¶æˆåŠŸ', 'åœ°å€å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                }).catch(() => {
                    showToast('å¤åˆ¶å¤±è´¥', 'æ— æ³•è®¿é—®å‰ªè´´æ¿', 'error');
                });
            }
        }

        // ä¿®æ”¹å¯†ç 
        async function changePassword() {
            const oldPassword = document.getElementById('old-password').value;
            const newPassword = document.getElementById('new-password').value;
            
            if (!oldPassword || !newPassword) {
                showToast('è¾“å…¥é”™è¯¯', 'è¯·è¾“å…¥å½“å‰å¯†ç å’Œæ–°å¯†ç ', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/change_password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        old_password: oldPassword,
                        new_password: newPassword
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    showToast('ä¿®æ”¹æˆåŠŸ', 'ç®¡ç†å‘˜å¯†ç å·²æ›´æ–°', 'success');
                    document.getElementById('old-password').value = '';
                    document.getElementById('new-password').value = '';
                } else {
                    showToast('ä¿®æ”¹å¤±è´¥', data.message || 'å¯†ç éªŒè¯å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ä¿®æ”¹å¤±è´¥', 'ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        }

        // åŠ è½½æ¡æ¼è´¦å·åˆ—è¡¨
        async function loadFallbackAccounts() {
            try {
                const response = await fetch('/api/settings/fallback-accounts');
                const data = await response.json();
                
                if (data.success && data.accounts) {
                    const tbody = document.getElementById('fallback-accounts-list');
                    tbody.innerHTML = data.accounts.map((acc, idx) => `
                        <tr class="hover:bg-slate-50">
                            <td class="px-4 py-3 text-slate-700">#${idx + 1}</td>
                            <td class="px-4 py-3 font-medium text-slate-800">@${acc.username || 'æœªè®¾ç½®'}</td>
                            <td class="px-4 py-3 text-slate-600">${acc.telegram_id || '-'}</td>
                            <td class="px-4 py-3 font-semibold text-green-600">${acc.balance || 0} U</td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs">
                                    ${acc.is_vip ? 'VIP' : 'æ™®é€š'}
                                </span>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('åŠ è½½æ¡æ¼è´¦å·å¤±è´¥:', error);
            }
        }

        // åŠ è½½Bot Tokenåˆ—è¡¨
        async function loadBotTokens() {
            try {
                const response = await fetch('/api/settings/bot-tokens');
                const data = await response.json();
                
                if (data.success && data.tokens) {
                    const container = document.getElementById('bot-tokens-list');
                    if (data.tokens.length === 0) {
                        container.innerHTML = '<p class="text-slate-400 text-sm text-center py-4">æš‚æ— Token</p>';
                    } else {
                        container.innerHTML = data.tokens.map((token, idx) => `
                            <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg">
                                <span class="text-sm font-medium text-slate-600">#${idx + 1}</span>
                                <input type="text" value="${token.substring(0, 20)}..." disabled class="flex-1 bg-white border-0 ring-1 ring-slate-200 rounded-lg px-3 py-2 text-sm">
                                <button onclick="deleteBotToken(${idx})" class="px-3 py-2 bg-red-100 hover:bg-red-200 text-red-600 rounded-lg text-sm transition-all">
                                    <i class="ti ti-trash"></i>
                                </button>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('åŠ è½½Bot Tokenå¤±è´¥:', error);
            }
        }

        // æ·»åŠ Bot Token
        async function addBotToken() {
            const token = document.getElementById('new-bot-token').value.trim();
            if (!token) {
                showToast('è¾“å…¥é”™è¯¯', 'è¯·è¾“å…¥Bot Token', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/settings/bot-tokens', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token })
                });
                const data = await response.json();
                
                if (data.success) {
                    showToast('æ·»åŠ æˆåŠŸ', 'Bot Tokenå·²æ·»åŠ ', 'success');
                    document.getElementById('new-bot-token').value = '';
                    loadBotTokens();
                } else {
                    showToast('æ·»åŠ å¤±è´¥', data.message, 'error');
                }
            } catch (error) {
                showToast('æ·»åŠ å¤±è´¥', 'ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // åˆ é™¤Bot Token
        async function deleteBotToken(index) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªTokenå—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/api/settings/bot-tokens/${index}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    showToast('åˆ é™¤æˆåŠŸ', 'Tokenå·²åˆ é™¤', 'success');
                    loadBotTokens();
                } else {
                    showToast('åˆ é™¤å¤±è´¥', data.message, 'error');
                }
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥', 'ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // å‘å¸ƒç½®é¡¶å¹¿å‘Šåˆ°æ‰€æœ‰ç¾¤
        async function updatePinnedAd() {
            const content = document.getElementById('pinned-ad-content').value.trim();
            if (!content) {
                showToast('è¾“å…¥é”™è¯¯', 'è¯·è¾“å…¥å¹¿å‘Šå†…å®¹', 'error');
                return;
            }
            
            if (!confirm('ç¡®å®šè¦å°†æ­¤å¹¿å‘Šå‘å¸ƒåˆ°æ‰€æœ‰ä¼šå‘˜ç¾¤å¹¶ç½®é¡¶å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch('/api/publish-pinned-ad', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
                const data = await response.json();
                
                if (data.success) {
                    showToast('å‘å¸ƒæˆåŠŸ', data.message, 'success');
                } else {
                    showToast('å‘å¸ƒå¤±è´¥', data.message || 'æœªçŸ¥é”™è¯¯', 'error');
                }
            } catch (error) {
                showToast('å‘å¸ƒå¤±è´¥', 'ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        }

        // æ›´æ–°ç¾¤æ¬¢è¿è¯­
        async function updateWelcomeMessage() {
            const content = document.getElementById('welcome-message-content').value.trim();
            if (!content) {
                showToast('è¾“å…¥é”™è¯¯', 'è¯·è¾“å…¥æ¬¢è¿è¯­å†…å®¹', 'error');
                return;
            }
            updateSetting('welcome_message', content, 'ç¾¤æ¬¢è¿è¯­å·²æ›´æ–°');
        }

        window.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            loadFallbackAccounts();
            loadBotTokens();
            
            // åŠ è½½ç½®é¡¶å¹¿å‘Šå’Œæ¬¢è¿è¯­
            fetch('/api/settings').then(r => r.json()).then(data => {
                if (data.success && data.settings) {
                    document.getElementById('pinned-ad-content').value = data.settings.pinned_ad || '';
                    document.getElementById('welcome-message-content').value = data.settings.welcome_message || '';
                }
            }).catch(err => console.error('åŠ è½½é…ç½®å¤±è´¥:', err));
            
            // è‡ªåŠ¨é«˜äº®å½“å‰é¡µé¢å¯¼èˆªæ 
            const currentPath = window.location.pathname;
            const navLinks = document.querySelectorAll('aside nav a[href]');
            navLinks.forEach(link => {
                const href = link.getAttribute('href');
                link.classList.remove('bg-indigo-50', 'text-indigo-600', 'border', 'border-indigo-100/50', 'shadow-sm');
                link.classList.add('hover:bg-slate-50', 'text-slate-500', 'hover:text-slate-900');
                
                if ((currentPath === '/' && href === '/') || (currentPath === href && href !== '/')) {
                    link.classList.remove('hover:bg-slate-50', 'text-slate-500', 'hover:text-slate-900');
                    link.classList.add('bg-indigo-50', 'text-indigo-600', 'border', 'border-indigo-100/50', 'shadow-sm');
                }
            });
        });
</script>
{% endblock %}
