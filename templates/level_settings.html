{% extends "base.html" %}

{% block title %}ç³»ç»Ÿè®¾ç½®{% endblock %}

{% block content %}
<main class="px-6 py-8 fade-in-up">
    <div class="mb-6">
        <h2 class="text-2xl font-bold text-slate-900 tracking-tight">ç³»ç»Ÿè®¾ç½®</h2>
        <p class="text-slate-500 mt-1">ç®¡ç†ç³»ç»Ÿå„é¡¹é…ç½®å‚æ•°</p>
    </div>

    <!-- Tabå¯¼èˆª -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 mb-6">
        <div class="flex border-b border-slate-200 overflow-x-auto">
            <button onclick="switchTab('level')" id="tab-level" class="tab-btn px-5 py-3 text-sm font-medium border-b-2 border-indigo-500 text-indigo-600 whitespace-nowrap">
                <i class="ti ti-hierarchy-2 mr-1"></i>å±‚çº§è®¾ç½®
            </button>
            <!-- æ¡æ¼è´¦å·å·²ç§»å…¥ç‹¬ç«‹é¡µé¢ï¼Œç³»ç»Ÿè®¾ç½®ä¸­ä¸å†æ˜¾ç¤º -->
            <button onclick="switchTab('customer')" id="tab-customer" class="tab-btn px-5 py-3 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-slate-700 whitespace-nowrap">
                <i class="ti ti-headset mr-1"></i>å®¢æœè®¾ç½®
            </button>
            <button onclick="switchTab('system')" id="tab-system" class="tab-btn px-5 py-3 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-slate-700 whitespace-nowrap">
                <i class="ti ti-settings mr-1"></i>ç³»ç»Ÿé…ç½®
            </button>
            <button onclick="switchTab('payment')" id="tab-payment" class="tab-btn px-5 py-3 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-slate-700 whitespace-nowrap">
                <i class="ti ti-credit-card mr-1"></i>æ”¯ä»˜é…ç½®
            </button>
        </div>
    </div>

    <!-- ===== å±‚çº§è®¾ç½® ===== -->
    <div id="content-level" class="tab-content">
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <label class="block text-sm font-medium text-slate-700 mb-2">å±‚çº§æ•°é‡</label>
                <div class="flex items-center gap-4">
                    <input type="number" id="levelCount" min="1" max="20" value="10" class="w-24 px-3 py-2 text-center border border-slate-300 rounded-lg">
                    <span class="text-slate-600">å±‚</span>
                    <button onclick="updateLevelCount()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"><i class="ti ti-check mr-1"></i>ç¡®è®¤</button>
                </div>
            </div>
            <div class="mb-6 p-4 bg-amber-50 rounded-lg border border-amber-200">
                <label class="block text-sm font-medium text-slate-700 mb-2">å¿«æ·è®¾ç½®</label>
                <div class="flex items-center gap-4">
                    <input type="number" id="quickAmount" min="0" step="0.1" value="10" class="w-24 px-3 py-2 text-center border border-slate-300 rounded-lg">
                    <span class="text-slate-600">U</span>
                    <button onclick="fillAllLevels()" class="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600"><i class="ti ti-copy mr-1"></i>å…¨éƒ¨è®¾ç½®</button>
                </div>
            </div>
            <div class="mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-slate-700">æ¯å±‚é‡‘é¢è®¾ç½®</h3>
                    <div class="text-sm">å‡çº§VIPæ€»é‡‘é¢ï¼š<span id="totalAmount" class="font-bold text-green-600 text-lg">0</span> U</div>
                </div>
                <div id="levelSettings" class="grid grid-cols-2 md:grid-cols-5 gap-3"></div>
            </div>
            <div class="flex justify-between items-center pt-4 border-t">
                <button onclick="loadLevelSettings()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"><i class="ti ti-refresh mr-1"></i>é‡æ–°åŠ è½½</button>
                <button onclick="saveLevelSettings()" class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600"><i class="ti ti-device-floppy mr-1"></i>ä¿å­˜å±‚çº§è®¾ç½®</button>
            </div>
        </div>
    </div>

    <!-- æ¡æ¼è´¦å·ç®¡ç†å·²ç§»è‡³ç‹¬ç«‹é¡µé¢ /fallback-accounts -->

    <!-- ===== å®¢æœè®¾ç½® ===== -->
    <div id="content-customer" class="tab-content hidden">
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-slate-700">å®¢æœåˆ—è¡¨</h3>
                <button onclick="showAddCustomerModal()" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600"><i class="ti ti-plus mr-1"></i>æ·»åŠ å®¢æœ</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="px-4 py-3 text-left">ID</th>
                            <th class="px-4 py-3 text-left">å®¢æœåç§°</th>
                            <th class="px-4 py-3 text-left">è”ç³»é“¾æ¥</th>
                            <th class="px-4 py-3 text-left">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="customerList"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ===== ç³»ç»Ÿé…ç½® ===== -->
    <div id="content-system" class="tab-content hidden">
        <!-- åŸºç¡€è®¾ç½®å¡ç‰‡ -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-4 mb-6">
            <div class="bg-white rounded-xl p-5 border border-slate-200 shadow-sm">
                <div class="flex items-center gap-2 mb-3">
                    <div class="p-2 bg-purple-50 text-purple-600 rounded-lg"><i class="ti ti-wallet text-xl"></i></div>
                    <span class="text-xs font-semibold text-slate-500">é£æ§</span>
                </div>
                <p class="text-sm text-slate-500 mb-2">æœ€ä½æç°é—¨æ§›</p>
                <div class="flex gap-2">
                    <input type="number" id="sysMinWithdraw" class="flex-1 px-3 py-2 text-sm border rounded-lg" value="10">
                    <button onclick="updateSetting('withdraw_threshold', document.getElementById('sysMinWithdraw').value)" class="px-3 py-2 bg-slate-900 text-white rounded-lg"><i class="ti ti-check"></i></button>
                </div>
            </div>
            <div class="bg-white rounded-xl p-5 border border-slate-200 shadow-sm">
                <div class="flex items-center gap-2 mb-3">
                    <div class="p-2 bg-rose-50 text-rose-600 rounded-lg"><i class="ti ti-percentage text-xl"></i></div>
                    <span class="text-xs font-semibold text-slate-500">æ‰‹ç»­è´¹</span>
                </div>
                <p class="text-sm text-slate-500 mb-2">æç°æ‰‹ç»­è´¹(%)</p>
                <div class="flex gap-2">
                    <input type="number" id="sysWithdrawFee" class="flex-1 px-3 py-2 text-sm border rounded-lg" value="5">
                    <button onclick="updateSetting('withdraw_fee', document.getElementById('sysWithdrawFee').value)" class="px-3 py-2 bg-slate-900 text-white rounded-lg"><i class="ti ti-check"></i></button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- ä¿®æ”¹å¯†ç  -->
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
                <div class="flex items-center gap-3 mb-4">
                    <div class="h-10 w-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600"><i class="ti ti-lock text-xl"></i></div>
                    <div>
                        <h3 class="text-base font-bold text-slate-900">å®‰å…¨è®¾ç½®</h3>
                        <p class="text-sm text-slate-500">ä¿®æ”¹ç®¡ç†å‘˜å¯†ç </p>
                    </div>
                </div>
                <div class="space-y-3">
                    <input type="password" id="oldPassword" class="w-full px-4 py-2 border rounded-lg text-sm" placeholder="å½“å‰å¯†ç ">
                    <input type="password" id="newPassword" class="w-full px-4 py-2 border rounded-lg text-sm" placeholder="æ–°å¯†ç ">
                </div>
                <div class="flex justify-end mt-3">
                    <button onclick="changePassword()" class="px-4 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-800">ç¡®è®¤ä¿®æ”¹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== æ”¯ä»˜é…ç½® ===== -->
    <div id="content-payment" class="tab-content hidden">
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-slate-700 mb-4">æ”¯ä»˜æ¥å£é…ç½®</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">æ”¯ä»˜è¯·æ±‚é“¾æ¥</label>
                        <input type="text" id="paymentUrl" class="w-full px-4 py-2 border border-slate-300 rounded-lg text-sm" placeholder="https://api.example.com/pay">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">æ”¯ä»˜Token</label>
                        <input type="text" id="paymentToken" class="w-full px-4 py-2 border border-slate-300 rounded-lg text-sm" placeholder="è¾“å…¥æ”¯ä»˜Token">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">æ”¯ä»˜æ±‡ç‡</label>
                        <input type="number" id="paymentRate" step="0.01" class="w-full px-4 py-2 border border-slate-300 rounded-lg text-sm" placeholder="1.00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">æ”¯ä»˜é€šé“</label>
                        <input type="text" id="paymentChannel" class="w-full px-4 py-2 border border-slate-300 rounded-lg text-sm" placeholder="trc20" value="trc20">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-slate-700 mb-2">ç”¨æˆ·ID</label>
                        <input type="text" id="paymentUserId" class="w-full px-4 py-2 border border-slate-300 rounded-lg text-sm" placeholder="è¾“å…¥ç”¨æˆ·ID">
                    </div>
                </div>
            </div>
            <div class="flex justify-end pt-4 border-t">
                <button onclick="savePaymentConfig()" class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600"><i class="ti ti-device-floppy mr-1"></i>ä¿å­˜æ”¯ä»˜é…ç½®</button>
            </div>
        </div>
    </div>

</main>

<!-- Toast -->
<div id="toast" class="fixed top-4 right-4 z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg border p-4 flex items-center gap-3">
        <span id="toastIcon"></span>
        <div>
            <div id="toastTitle" class="font-medium"></div>
            <div id="toastMessage" class="text-sm text-slate-500"></div>
        </div>
    </div>
</div>

<!-- æ¡æ¼è´¦å·å¼¹çª—å·²ç§»é™¤ï¼ˆä½¿ç”¨ /fallback-accounts é¡µé¢ï¼‰ -->

<!-- å®¢æœç¼–è¾‘å¼¹çª— -->
<div id="customerModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-xl p-6 w-full max-w-md">
        <h3 id="customerModalTitle" class="text-lg font-bold mb-4">æ·»åŠ å®¢æœ</h3>
        <input type="hidden" id="customerId">
        <div class="mb-4">
            <label class="block text-sm font-medium mb-1">å®¢æœåç§°</label>
            <input type="text" id="customerName" class="w-full px-3 py-2 border rounded-lg">
        </div>
        <div class="mb-4">
            <label class="block text-sm font-medium mb-1">è”ç³»é“¾æ¥</label>
            <input type="text" id="customerLink" class="w-full px-3 py-2 border rounded-lg" placeholder="https://t.me/...">
        </div>
        <div class="flex justify-end gap-2">
            <button onclick="closeCustomerModal()" class="px-4 py-2 border rounded-lg">å–æ¶ˆ</button>
            <button onclick="saveCustomerService()" class="px-4 py-2 bg-indigo-500 text-white rounded-lg">ä¿å­˜</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentLevelCount = 10;

function showToast(title, message, type = 'success') {
    const toast = document.getElementById('toast');
    document.getElementById('toastTitle').textContent = title;
    document.getElementById('toastMessage').textContent = message;
    document.getElementById('toastIcon').className = type === 'success' ? 'ti ti-check text-green-500 text-xl' : 'ti ti-x text-red-500 text-xl';
    toast.classList.remove('hidden');
    setTimeout(() => toast.classList.add('hidden'), 3000);
}

function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('border-indigo-500', 'text-indigo-600');
        btn.classList.add('border-transparent', 'text-slate-500');
    });
    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
    document.getElementById('tab-' + tab).classList.add('border-indigo-500', 'text-indigo-600');
    document.getElementById('tab-' + tab).classList.remove('border-transparent', 'text-slate-500');
    document.getElementById('content-' + tab).classList.remove('hidden');
    
    if (tab === 'level') loadLevelSettings();
    else if (tab === 'customer') loadCustomerServices();
    else if (tab === 'system') loadSystemSettings();
    else if (tab === 'payment') loadPaymentConfig();
}

// ===== å±‚çº§è®¾ç½® =====
function updateLevelCount() {
    const count = parseInt(document.getElementById('levelCount').value) || 10;
    if (count < 1 || count > 20) { showToast('é”™è¯¯', 'å±‚çº§æ•°é‡å¿…é¡»åœ¨1-20ä¹‹é—´', 'error'); return; }
    currentLevelCount = count;
    renderLevelInputs();
    showToast('æˆåŠŸ', `å·²è®¾ç½®ä¸º${count}å±‚`);
}

function renderLevelInputs() {
    let html = '';
    for (let i = 1; i <= currentLevelCount; i++) {
        // ä¸è®¾ç½®é»˜è®¤valueï¼Œè®©loadLevelSettingsæ¥è®¾ç½®å€¼
        html += `<div class="flex items-center gap-2 p-3 bg-slate-50 rounded-lg border"><span class="text-sm font-medium w-12">${i}å±‚</span><input type="number" id="level_${i}" min="0" step="0.1" onchange="calculateTotal()" class="flex-1 px-2 py-1 text-center border rounded text-sm"><span class="text-xs text-slate-500">U</span></div>`;
    }
    document.getElementById('levelSettings').innerHTML = html;
    // ä¸åœ¨è¿™é‡Œè°ƒç”¨calculateTotalï¼Œè®©loadLevelSettingsæ§åˆ¶
}

function fillAllLevels() {
    const amount = parseFloat(document.getElementById('quickAmount').value) || 0;
    for (let i = 1; i <= currentLevelCount; i++) {
        const input = document.getElementById(`level_${i}`);
        if (input) input.value = amount;
    }
    calculateTotal();
    showToast('æˆåŠŸ', `å·²å°†æ‰€æœ‰å±‚çº§è®¾ç½®ä¸º ${amount} U`);
}

function calculateTotal() {
    let total = 0;
    for (let i = 1; i <= currentLevelCount; i++) {
        const input = document.getElementById(`level_${i}`);
        if (input) total += parseFloat(input.value) || 0;
    }
    document.getElementById('totalAmount').textContent = total.toFixed(1);
}

async function loadLevelSettings() {
    try {
        console.log('ğŸ”„ å¼€å§‹åŠ è½½å±‚çº§è®¾ç½®...');
        const timestamp = Date.now();
        const res = await fetch(`/api/level-settings?t=${timestamp}`, {
            cache: 'no-cache',
            headers: {
                'Cache-Control': 'no-cache',
                'Pragma': 'no-cache'
            }
        });
        console.log('ğŸ“¡ APIå“åº”çŠ¶æ€:', res.status);
        const data = await res.json();
        console.log('ğŸ“Š APIè¿”å›æ•°æ®:', data);

        if (data.success) {
            currentLevelCount = data.level_count || 10;
            console.log('ğŸ“ è®¾ç½®å±‚æ•°ä¸º:', currentLevelCount);
            document.getElementById('levelCount').value = currentLevelCount;
            renderLevelInputs();

            // ç­‰å¾…DOMæ›´æ–°å®Œæˆ
            await new Promise(resolve => setTimeout(resolve, 100));

            if (data.level_amounts && Array.isArray(data.level_amounts)) {
                console.log('ğŸ’° è®¾ç½®é‡‘é¢æ•°ç»„:', data.level_amounts);
                for (let i = 1; i <= currentLevelCount; i++) {
                    const input = document.getElementById(`level_${i}`);
                    const value = data.level_amounts[i-1];
                    console.log(`ğŸ”¢ è®¾ç½®ç¬¬${i}å±‚: å…ƒç´ ç´¢å¼•${i-1}, å€¼=${value}, è¾“å…¥æ¡†å­˜åœ¨=${!!input}`);
                    if (input && value !== undefined) {
                        input.value = value;
                        console.log(`âœ… å·²è®¾ç½®è¾“å…¥æ¡† level_${i} = ${value}`);
                        // æ‰‹åŠ¨è§¦å‘changeäº‹ä»¶
                        input.dispatchEvent(new Event('change', { bubbles: true }));
                    } else {
                        console.log(`âŒ æ— æ³•è®¾ç½®è¾“å…¥æ¡† level_${i}, input=${!!input}, value=${value}`);
                    }
                }
            } else {
                console.log('âŒ level_amountsä¸æ˜¯æ•°ç»„æˆ–ä¸å­˜åœ¨:', data.level_amounts);
            }

            // å†æ¬¡ç­‰å¾…ç¡®ä¿å€¼è®¾ç½®å®Œæˆ
            await new Promise(resolve => setTimeout(resolve, 50));
            calculateTotal();
            console.log('âœ… å±‚çº§è®¾ç½®åŠ è½½å®Œæˆ');

            // æ˜¾ç¤ºå½“å‰æ€»é‡‘é¢
            const totalElement = document.getElementById('totalAmount');
            if (totalElement) {
                console.log('ğŸ’µ å½“å‰æ˜¾ç¤ºçš„æ€»é‡‘é¢:', totalElement.textContent);
            }
        } else {
            console.log('âŒ APIè¿”å›å¤±è´¥:', data);
        }
    } catch (e) {
        console.error('âŒ åŠ è½½å±‚çº§è®¾ç½®å¤±è´¥:', e);
    }
}

async function saveLevelSettings() {
    const levelAmounts = [];
    for (let i = 1; i <= currentLevelCount; i++) {
        levelAmounts.push(parseFloat(document.getElementById(`level_${i}`)?.value) || 0);
    }
    try {
        const res = await fetch('/api/level-settings', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ level_count: currentLevelCount, level_amounts: levelAmounts })
        });
        const data = await res.json();
        if (data.success) {
            showToast('æˆåŠŸ', 'å±‚çº§è®¾ç½®å·²ä¿å­˜');
            // ä¿å­˜æˆåŠŸåé‡æ–°åŠ è½½æ•°æ®ï¼Œç¡®ä¿æ˜¾ç¤ºæœ€æ–°å€¼
            loadLevelSettings();
        }
        else showToast('é”™è¯¯', data.message, 'error');
    } catch (e) { showToast('é”™è¯¯', e.message, 'error'); }
}

/* æ¡æ¼è´¦å·ç®¡ç†å·²ç§»è‡³ç‹¬ç«‹é¡µé¢ /fallback-accountsï¼ˆç›¸å…³è„šæœ¬ç§»é™¤ï¼‰ */

// ===== å®¢æœè®¾ç½® =====
async function loadCustomerServices() {
    try {
        const res = await fetch('/api/customer_services');
        const data = await res.json();
        let html = '';
        if (data && data.length > 0) {
            data.forEach(svc => {
                html += `<tr class="border-b"><td class="px-4 py-3">${svc.id}</td><td class="px-4 py-3 font-medium">${svc.name}</td><td class="px-4 py-3"><a href="${svc.link}" target="_blank" class="text-blue-500">${svc.link}</a></td><td class="px-4 py-3"><button onclick="editCustomer(${svc.id},'${svc.name}','${svc.link}')" class="text-blue-500 mr-2">ç¼–è¾‘</button><button onclick="deleteCustomer(${svc.id},'${svc.name}')" class="text-red-500">åˆ é™¤</button></td></tr>`;
            });
        }
        document.getElementById('customerList').innerHTML = html || '<tr><td colspan="4" class="px-4 py-8 text-center text-slate-400">æš‚æ— æ•°æ®</td></tr>';
    } catch (e) { console.error(e); }
}

function showAddCustomerModal() {
    document.getElementById('customerId').value = '';
    document.getElementById('customerName').value = '';
    document.getElementById('customerLink').value = '';
    document.getElementById('customerModalTitle').textContent = 'æ·»åŠ å®¢æœ';
    document.getElementById('customerModal').classList.remove('hidden');
}

function editCustomer(id, name, link) {
    document.getElementById('customerId').value = id;
    document.getElementById('customerName').value = name;
    document.getElementById('customerLink').value = link;
    document.getElementById('customerModalTitle').textContent = 'ç¼–è¾‘å®¢æœ';
    document.getElementById('customerModal').classList.remove('hidden');
}

function closeCustomerModal() { document.getElementById('customerModal').classList.add('hidden'); }

async function saveCustomerService() {
    const id = document.getElementById('customerId').value;
    const name = document.getElementById('customerName').value;
    const link = document.getElementById('customerLink').value;
    if (!name || !link) { showToast('é”™è¯¯', 'è¯·å¡«å†™æ‰€æœ‰å­—æ®µ', 'error'); return; }
    try {
        const url = id ? `/api/customer_services/${id}` : '/api/customer_services';
        const res = await fetch(url, {
            method: id ? 'PUT' : 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name, link })
        });
        const data = await res.json();
        if (data.success) { showToast('æˆåŠŸ', 'ä¿å­˜æˆåŠŸ'); closeCustomerModal(); loadCustomerServices(); }
        else showToast('é”™è¯¯', data.message, 'error');
    } catch (e) { showToast('é”™è¯¯', e.message, 'error'); }
}

async function deleteCustomer(id, name) {
    if (!confirm(`ç¡®å®šåˆ é™¤å®¢æœ"${name}"å—ï¼Ÿ`)) return;
    try {
        const res = await fetch(`/api/customer_services/${id}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) { showToast('æˆåŠŸ', 'åˆ é™¤æˆåŠŸ'); loadCustomerServices(); }
        else showToast('é”™è¯¯', data.message, 'error');
    } catch (e) { showToast('é”™è¯¯', e.message, 'error'); }
}

// ===== ç³»ç»Ÿé…ç½® =====
async function loadSystemSettings() {
    try {
        const res = await fetch('/api/settings');
        const data = await res.json();
        if (data.success && data.settings) {
            const s = data.settings;
            // åªè®¾ç½®å­˜åœ¨çš„å…ƒç´ 
            const minWithdrawEl = document.getElementById('sysMinWithdraw');
            if (minWithdrawEl) minWithdrawEl.value = s.withdraw_threshold || 10;
            
            const withdrawFeeEl = document.getElementById('sysWithdrawFee');
            if (withdrawFeeEl) withdrawFeeEl.value = s.withdraw_fee || 5;
            
            const pinnedAdEl = document.getElementById('pinnedAdContent');
            if (pinnedAdEl) pinnedAdEl.value = s.pinned_ad || '';
            
            const welcomeMsgEl = document.getElementById('welcomeMessage');
            if (welcomeMsgEl) welcomeMsgEl.value = s.welcome_message || '';
        }
        loadBotTokens();
    } catch (e) { console.error('åŠ è½½ç³»ç»Ÿè®¾ç½®å¤±è´¥:', e); }
}

async function updateSetting(key, value) {
    try {
        const res = await fetch('/api/settings', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ key: key, value: value })
        });
        const data = await res.json();
        if (data.success) { showToast('æˆåŠŸ', 'è®¾ç½®å·²æ›´æ–°'); }
        else showToast('é”™è¯¯', data.message, 'error');
    } catch (e) { showToast('é”™è¯¯', e.message, 'error'); }
}

async function changePassword() {
    const oldPwd = document.getElementById('oldPassword').value;
    const newPwd = document.getElementById('newPassword').value;
    if (!oldPwd || !newPwd) { showToast('é”™è¯¯', 'è¯·å¡«å†™å¯†ç ', 'error'); return; }
    try {
        const res = await fetch('/api/change-password', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ old_password: oldPwd, new_password: newPwd })
        });
        const data = await res.json();
        if (data.success) { showToast('æˆåŠŸ', 'å¯†ç å·²ä¿®æ”¹'); document.getElementById('oldPassword').value = ''; document.getElementById('newPassword').value = ''; }
        else showToast('é”™è¯¯', data.message, 'error');
    } catch (e) { showToast('é”™è¯¯', e.message, 'error'); }
}

async function loadBotTokens() {
    try {
        const res = await fetch('/api/settings/bot-tokens');
        const data = await res.json();
        let html = '';
        if (data.success && data.tokens && data.tokens.length > 0) {
            data.tokens.forEach((token, i) => {
                html += `<div class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg"><span class="text-sm font-medium">#${i + 1}</span><input type="text" value="${token.substring(0, 20)}..." disabled class="flex-1 bg-white border rounded-lg px-3 py-2 text-sm"><button onclick="deleteBotToken(${i})" class="px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200"><i class="ti ti-trash"></i></button></div>`;
            });
        } else {
            html = '<p class="text-slate-400 text-sm text-center py-4">æš‚æ— Token</p>';
        }
        const botTokensListEl = document.getElementById('botTokensList');
        if (botTokensListEl) {
            botTokensListEl.innerHTML = html;
        }
    } catch (e) { console.error('åŠ è½½Bot Tokenså¤±è´¥:', e); }
}

async function addBotToken() {
    const token = document.getElementById('newBotToken').value.trim();
    if (!token) { showToast('é”™è¯¯', 'è¯·è¾“å…¥Token', 'error'); return; }
    try {
        const res = await fetch('/api/settings/bot-tokens', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ token })
        });
        const data = await res.json();
        if (data.success) { showToast('æˆåŠŸ', 'Tokenå·²æ·»åŠ '); document.getElementById('newBotToken').value = ''; loadBotTokens(); }
        else showToast('é”™è¯¯', data.message, 'error');
    } catch (e) { showToast('é”™è¯¯', e.message, 'error'); }
}

async function deleteBotToken(index) {
    if (!confirm('ç¡®å®šåˆ é™¤æ­¤Token?')) return;
    try {
        const res = await fetch(`/api/settings/bot-tokens/${index}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) { showToast('æˆåŠŸ', 'Tokenå·²åˆ é™¤'); loadBotTokens(); }
        else showToast('é”™è¯¯', data.message, 'error');
    } catch (e) { showToast('é”™è¯¯', e.message, 'error'); }
}

async function publishPinnedAd() {
    const content = document.getElementById('pinnedAdContent').value.trim();
    if (!content) { showToast('é”™è¯¯', 'è¯·è¾“å…¥å¹¿å‘Šå†…å®¹', 'error'); return; }
    if (!confirm('ç¡®å®šå°†æ­¤å¹¿å‘Šå‘å¸ƒåˆ°æ‰€æœ‰ä¼šå‘˜ç¾¤å¹¶ç½®é¡¶å—ï¼Ÿ')) return;
    try {
        const res = await fetch('/api/publish-pinned-ad', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ content })
        });
        const data = await res.json();
        if (data.success) showToast('æˆåŠŸ', data.message);
        else showToast('é”™è¯¯', data.message, 'error');
    } catch (e) { showToast('é”™è¯¯', e.message, 'error'); }
}

// ===== æ”¯ä»˜é…ç½® =====
async function loadPaymentConfig() {
    try {
        const res = await fetch('/api/payment-config');
        const data = await res.json();
        if (data.success && data.config) {
            document.getElementById('paymentUrl').value = data.config.payment_url || '';
            document.getElementById('paymentToken').value = data.config.payment_token || '';
            document.getElementById('paymentRate').value = data.config.payment_rate || 1.00;
            document.getElementById('paymentChannel').value = data.config.payment_channel || 'trc20';
            document.getElementById('paymentUserId').value = data.config.payment_user_id || '';
        }
    } catch (e) { console.error('åŠ è½½æ”¯ä»˜é…ç½®å¤±è´¥:', e); }
}

async function savePaymentConfig() {
    const config = {
        payment_url: document.getElementById('paymentUrl').value.trim(),
        payment_token: document.getElementById('paymentToken').value.trim(),
        payment_rate: parseFloat(document.getElementById('paymentRate').value) || 1.00,
        payment_channel: document.getElementById('paymentChannel').value.trim() || 'trc20',
        payment_user_id: document.getElementById('paymentUserId').value.trim()
    };
    
    if (!config.payment_url || !config.payment_token) {
        showToast('é”™è¯¯', 'è¯·å¡«å†™æ”¯ä»˜è¯·æ±‚é“¾æ¥å’ŒToken', 'error');
        return;
    }
    
    try {
        const res = await fetch('/api/payment-config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(config)
        });
        const data = await res.json();
        if (data.success) showToast('æˆåŠŸ', 'æ”¯ä»˜é…ç½®å·²ä¿å­˜');
        else showToast('é”™è¯¯', data.message, 'error');
    } catch (e) { showToast('é”™è¯¯', e.message, 'error'); }
}

document.addEventListener('DOMContentLoaded', () => loadLevelSettings());
</script>
{% endblock %}
