{% extends "base.html" %}

{% block title %}å›¢é˜Ÿå›¾è°±{% endblock %}

{% block content %}
<main class="px-6 py-8">
        <div class="mb-6">
            <h1 class="text-3xl font-bold text-slate-900">å›¢é˜Ÿå›¾è°±</h1>
            <p class="text-slate-500 mt-2">æŸ¥çœ‹ä¸Šä¸‹10å±‚å…³ç³»å›¾</p>
        </div>
        
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <!-- ä¸Šçº§é“¾ -->
            <div id="uplinesSection" class="mb-8">
                <h2 class="text-xl font-bold text-slate-900 mb-4 flex items-center gap-2">
                    <i class="ti ti-arrow-up text-indigo-600"></i>
                    ä¸Šçº§é“¾ï¼ˆå‘ä¸Š10å±‚ï¼‰
                </h2>
                <div id="uplinesContent" class="space-y-2">
                    <p class="text-slate-400">åŠ è½½ä¸­...</p>
                </div>
            </div>
            
            <!-- å½“å‰ç”¨æˆ· -->
            <div id="centerSection" class="mb-8 p-6 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl border-2 border-indigo-200">
                <h2 class="text-xl font-bold text-slate-900 mb-4 flex items-center gap-2">
                    <i class="ti ti-user-circle text-indigo-600"></i>
                    å½“å‰ç”¨æˆ·
                </h2>
                <div id="centerContent">
                    <p class="text-slate-400">åŠ è½½ä¸­...</p>
                </div>
            </div>
            
            <!-- ä¸‹çº§æ ‘ -->
            <div id="downlinesSection">
                <h2 class="text-xl font-bold text-slate-900 mb-4 flex items-center gap-2">
                    <i class="ti ti-arrow-down text-green-600"></i>
                    ä¸‹çº§æ ‘ï¼ˆå‘ä¸‹10å±‚ï¼‰
                </h2>
                <div id="downlinesContent" class="space-y-2">
                    <p class="text-slate-400">åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>
        
</main>

<script>
        const telegramId = {{ telegram_id }};
        
        async function loadGraph() {
            try {
                const res = await fetch(`/api/team-graph/${telegramId}`);
                const data = await res.json();
                
                if (data.error) {
                    alert('åŠ è½½å¤±è´¥: ' + data.error);
                    return;
                }
                
                // æ˜¾ç¤ºä¸­å¿ƒç”¨æˆ·
                if (data.center) {
                    document.getElementById('centerContent').innerHTML = `
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-lg font-bold text-slate-900">@${data.center.username || 'æœªçŸ¥'}</p>
                                <p class="text-sm text-slate-600">ID: ${data.center.telegram_id || 'æœªçŸ¥'}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-slate-600">ä½™é¢: <span class="font-bold text-indigo-600">${(data.center.balance || 0).toFixed(2)} U</span></p>
                                <p class="text-sm text-slate-600">ç´¯è®¡: <span class="font-bold text-green-600">${(data.center.total_earned || 0).toFixed(2)} U</span></p>
                            </div>
                        </div>
                        <div class="mt-3">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold ${data.center.is_vip ? 'bg-purple-100 text-purple-700' : 'bg-slate-100 text-slate-600'}">
                                ${data.center.is_vip ? 'ğŸ’ VIPä¼šå‘˜' : 'âŒ éVIP'}
                            </span>
                        </div>
                    `;
                } else {
                    document.getElementById('centerContent').innerHTML = '<p class="text-slate-400">æ— æ³•åŠ è½½ç”¨æˆ·ä¿¡æ¯</p>';
                }
                
                // æ˜¾ç¤ºä¸Šçº§
                if (data.uplines && Array.isArray(data.uplines) && data.uplines.length > 0) {
                    document.getElementById('uplinesContent').innerHTML = data.uplines.map(u => `
                        <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg border border-slate-200 hover:bg-indigo-50 hover:border-indigo-300 transition">
                            <span class="flex-shrink-0 w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center font-bold text-indigo-700">L${u.level || '?'}</span>
                            <div class="flex-1">
                                <p class="font-semibold text-slate-900">@${u.username || 'æœªçŸ¥'}</p>
                                <p class="text-xs text-slate-500">ID: ${u.telegram_id || 'æœªçŸ¥'}</p>
                                <p class="text-xs text-slate-400">ç›´æ¨: ${u.direct_count || 0} | å›¢é˜Ÿ: ${u.team_count || 0}</p>
                            </div>
                            <div class="flex gap-2">
                                <span class="text-lg" title="${u.is_vip ? 'VIP' : 'éVIP'}">${u.is_vip ? 'ğŸ’' : 'âŒ'}</span>
                                <span class="text-lg" title="${u.is_group_bound ? 'å·²ç»‘ç¾¤' : 'æœªç»‘ç¾¤'}">${u.is_group_bound ? 'ğŸ”—' : 'âŒ'}</span>
                                <span class="text-lg" title="${u.is_bot_admin ? 'ç¾¤ç®¡ç†å‘˜' : 'éç®¡ç†å‘˜'}">${u.is_bot_admin ? 'ğŸ‘‘' : 'âŒ'}</span>
                                <span class="text-lg" title="${u.is_joined_upline ? 'å·²åŠ ç¾¤' : 'æœªåŠ ç¾¤'}">${u.is_joined_upline ? 'âœ…' : 'âŒ'}</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('uplinesContent').innerHTML = '<p class="text-slate-400">æš‚æ— ä¸Šçº§</p>';
                }
                
                // æ˜¾ç¤ºä¸‹çº§
                if (data.downlines && Array.isArray(data.downlines) && data.downlines.length > 0) {
                    // æŒ‰å±‚çº§åˆ†ç»„
                    const levels = {};
                    data.downlines.forEach(d => {
                        if (!levels[d.level]) levels[d.level] = [];
                        levels[d.level].push(d);
                    });

                    document.getElementById('downlinesContent').innerHTML = Object.keys(levels).sort((a,b) => a-b).map(level => `
                        <div class="mb-4">
                            <h3 class="text-sm font-bold text-slate-700 mb-2">ç¬¬${level}å±‚ (${levels[level].length}äºº)</h3>
                            <div class="space-y-2">
                                ${levels[level].map(d => `
                                    <div class="flex items-center gap-3 p-2 bg-slate-50 rounded-lg border border-slate-200 text-sm">
                                        <span class="flex-shrink-0 w-8 h-8 rounded-full bg-green-100 flex items-center justify-center font-bold text-green-700 text-xs">L${d.level || '?'}</span>
                                        <div class="flex-1">
                                            <p class="font-semibold text-slate-900">@${d.username || 'æœªçŸ¥'}</p>
                                            <p class="text-xs text-slate-500">ç›´æ¨: ${d.direct_count || 0} | å›¢é˜Ÿ: ${d.team_count || 0}</p>
                                        </div>
                                        <div class="flex gap-1">
                                            <span title="${d.is_vip ? 'VIP' : 'éVIP'}">${d.is_vip ? 'ğŸ’' : 'âŒ'}</span>
                                            <span title="${d.is_group_bound ? 'å·²ç»‘ç¾¤' : 'æœªç»‘ç¾¤'}">${d.is_group_bound ? 'ğŸ”—' : 'âŒ'}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('downlinesContent').innerHTML = '<p class="text-slate-400">æš‚æ— ä¸‹çº§</p>';
                }
                
            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
                alert('åŠ è½½å¤±è´¥: ' + error.message);
            }
        }
        
loadGraph();
</script>
{% endblock %}
