{% extends "base.html" %}

{% block title %}å›¢é˜Ÿå›¾è°±{% endblock %}

{% block content %}
<main class="px-6 py-8">
        <div class="mb-6">
            <h1 class="text-3xl font-bold text-slate-900">å›¢é˜Ÿå›¾è°±</h1>
            <p class="text-slate-500 mt-2">æŸ¥çœ‹ä¸Šä¸‹10å±‚å…³ç³»å›¾</p>
        </div>
        
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <!-- ä¸Šçº§é“¾ -->
            <div id="uplinesSection" class="mb-8">
                <h2 class="text-xl font-bold text-slate-900 mb-4 flex items-center gap-2">
                    <i class="ti ti-arrow-up text-indigo-600"></i>
                    ä¸Šçº§é“¾ï¼ˆå‘ä¸Š10å±‚ï¼‰
                </h2>
                <div id="uplinesContent" class="space-y-2">
                    <p class="text-slate-400">åŠ è½½ä¸­...</p>
                </div>
            </div>
            
            <!-- å½“å‰ç”¨æˆ· -->
            <div id="centerSection" class="mb-8 p-6 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl border-2 border-indigo-200">
                <h2 class="text-xl font-bold text-slate-900 mb-4 flex items-center gap-2">
                    <i class="ti ti-user-circle text-indigo-600"></i>
                    å½“å‰ç”¨æˆ·
                </h2>
                <div id="centerContent">
                    <p class="text-slate-400">åŠ è½½ä¸­...</p>
                </div>
            </div>
            
            <!-- ä¸‹çº§æ ‘ -->
            <div id="downlinesSection">
                <h2 class="text-xl font-bold text-slate-900 mb-4 flex items-center gap-2">
                    <i class="ti ti-arrow-down text-green-600"></i>
                    ä¸‹çº§æ ‘ï¼ˆå‘ä¸‹10å±‚ï¼‰
                </h2>
                <div id="downlinesContent" class="space-y-2">
                    <p class="text-slate-400">åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>
        
</main>

<script>
        const telegramId = {{ telegram_id }};
        
        async function loadGraph() {
            try {
                const res = await fetch(`/api/member/${telegramId}/graph`);
                const data = await res.json();

                // --- æ ¸å¿ƒä¿®å¤ï¼šæ•°æ®å®‰å…¨æ£€æŸ¥ ---
                // å³ä½¿APIè¿”å›é”™è¯¯ï¼Œä¹Ÿæä¾›é»˜è®¤ç©ºå¯¹è±¡é˜²æ­¢JSå´©æºƒ
                const center = data.center || {
                    username: 'æ•°æ®åŠ è½½å¤±è´¥',
                    telegram_id: telegramId,
                    balance: 0,
                    total_earned: 0,
                    is_vip: 0
                };

                // æ˜¾ç¤ºä¸­å¿ƒç”¨æˆ·
                document.getElementById('centerContent').innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-lg font-bold text-slate-900">@${center.username || 'æœªçŸ¥'}</p>
                            <p class="text-sm text-slate-600">ID: ${center.telegram_id || telegramId}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-slate-600">ä½™é¢: <span class="font-bold text-indigo-600">${center.balance || 0} U</span></p>
                            <p class="text-sm text-slate-600">ç´¯è®¡: <span class="font-bold text-green-600">${center.total_earned || 0} U</span></p>
                        </div>
                    </div>
                    <div class="mt-3">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold ${center.is_vip ? 'bg-purple-100 text-purple-700' : 'bg-slate-100 text-slate-600'}">
                            ${center.is_vip ? 'ğŸ’ VIPä¼šå‘˜' : 'âŒ éVIP'}
                        </span>
                    </div>
                `;

                // æ˜¾ç¤ºä¸Šçº§ (å…¼å®¹ uplines æˆ– upline å­—æ®µ)
                const uplines = data.uplines || data.upline || [];
                if (uplines.length > 0) {
                    document.getElementById('uplinesContent').innerHTML = uplines.map(u => `
                        <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg border border-slate-200 hover:bg-indigo-50 hover:border-indigo-300 transition">
                            <span class="flex-shrink-0 w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center font-bold text-indigo-700">L${u.level || '?'}</span>
                            <div class="flex-1">
                                <p class="font-semibold text-slate-900">@${u.username || 'æœªçŸ¥'}</p>
                                <p class="text-xs text-slate-500">ID: ${u.telegram_id}</p>
                            </div>
                            <div class="flex gap-2">
                                <span class="text-lg" title="${u.is_vip ? 'VIP' : 'éVIP'}">${u.is_vip ? 'ğŸ’' : 'âŒ'}</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('uplinesContent').innerHTML = '<p class="text-slate-400">æš‚æ— ä¸Šçº§</p>';
                }
                
                // æ˜¾ç¤ºä¸‹çº§ (å…¼å®¹ downlines æˆ– downline å­—æ®µ)
                const downlines = data.downlines || data.downline || [];
                if (downlines.length > 0) {
                    // æŒ‰å±‚çº§åˆ†ç»„
                    const levels = {};
                    downlines.forEach(d => {
                        const lvl = d.level || 1;
                        if (!levels[lvl]) levels[lvl] = [];
                        levels[lvl].push(d);
                    });

                    document.getElementById('downlinesContent').innerHTML = Object.keys(levels).sort((a,b) => a-b).map(level => `
                        <div class="mb-4">
                            <h3 class="text-sm font-bold text-slate-700 mb-2">ç¬¬${level}å±‚ (${levels[level].length}äºº)</h3>
                            <div class="space-y-2">
                                ${levels[level].map(d => `
                                    <div class="flex items-center gap-3 p-2 bg-slate-50 rounded-lg border border-slate-200 text-sm">
                                        <div class="flex-1">
                                            <p class="font-semibold text-slate-900">@${d.username || 'æœªçŸ¥'}</p>
                                        </div>
                                        <div class="flex gap-1">
                                            <span title="${d.is_vip ? 'VIP' : 'éVIP'}">${d.is_vip ? 'ğŸ’' : 'âŒ'}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('downlinesContent').innerHTML = '<p class="text-slate-400">æš‚æ— ä¸‹çº§</p>';
                }
                
            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
                // å³ä½¿æŠ¥é”™ä¹Ÿä¸è¦å¼¹çª—ï¼Œåªæ˜¾ç¤ºé”™è¯¯æ–‡æœ¬
                document.getElementById('centerContent').innerHTML = `<p class="text-red-500">æ•°æ®åŠ è½½å¼‚å¸¸: ${error.message}</p>`;
            }
        }
        
loadGraph();
</script>
{% endblock %}
