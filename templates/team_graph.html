{% extends "base.html" %}

{% block title %}å›¢é˜Ÿå›¾è°±{% endblock %}

{% block content %}
<main class="px-6 py-8">
        <div class="mb-6">
            <h1 class="text-3xl font-bold text-slate-900">å›¢é˜Ÿå›¾è°±</h1>
            <p class="text-slate-500 mt-2">æŸ¥çœ‹ä¸Šä¸‹10å±‚å…³ç³»å›¾</p>
        </div>
        
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <!-- ä¸Šçº§é“¾ -->
            <div id="uplinesSection" class="mb-8">
                <h2 class="text-xl font-bold text-slate-900 mb-4 flex items-center gap-2">
                    <i class="ti ti-arrow-up text-indigo-600"></i>
                    ä¸Šçº§é“¾ï¼ˆå‘ä¸Š10å±‚ï¼‰
                </h2>
                <div id="uplinesContent" class="space-y-2">
                    <p class="text-slate-400">åŠ è½½ä¸­...</p>
                </div>
            </div>
            
            <!-- å½“å‰ç”¨æˆ· -->
            <div id="centerSection" class="mb-8 p-6 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl border-2 border-indigo-200">
                <h2 class="text-xl font-bold text-slate-900 mb-4 flex items-center gap-2">
                    <i class="ti ti-user-circle text-indigo-600"></i>
                    å½“å‰ç”¨æˆ·
                </h2>
                <div id="centerContent">
                    <p class="text-slate-400">åŠ è½½ä¸­...</p>
                </div>
            </div>
            
            <!-- ä¸‹çº§æ ‘ -->
            <div id="downlinesSection">
                <h2 class="text-xl font-bold text-slate-900 mb-4 flex items-center gap-2">
                    <i class="ti ti-arrow-down text-green-600"></i>
                    ä¸‹çº§æ ‘ï¼ˆå‘ä¸‹10å±‚ï¼‰
                </h2>
                <div id="downlinesContent" class="space-y-2">
                    <p class="text-slate-400">åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>
        
</main>

    <script>
        // è·å–telegram_idï¼Œå¦‚æœæœªå®šä¹‰åˆ™ä½¿ç”¨é»˜è®¤å€¼
        let telegramId;
        try {
            telegramId = {{ telegram_id | tojson }};
            if (telegramId === null || telegramId === undefined) {
                telegramId = 0;
            }
        } catch (e) {
            console.error('è·å–telegram_idå¤±è´¥:', e);
            telegramId = 0;
        }

        console.log('åˆå§‹åŒ–telegramId:', telegramId);

        async function loadGraph() {
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                document.getElementById('centerContent').innerHTML = '<p class="text-slate-400">æ­£åœ¨åŠ è½½æ•°æ®...</p>';
                document.getElementById('uplinesContent').innerHTML = '<p class="text-slate-400">æ­£åœ¨åŠ è½½...</p>';
                document.getElementById('downlinesContent').innerHTML = '<p class="text-slate-400">æ­£åœ¨åŠ è½½...</p>';

                const apiUrl = `/api/member/${telegramId}/graph`;
                console.log('è¯·æ±‚API:', apiUrl);

                const res = await fetch(apiUrl);
                console.log('APIå“åº”çŠ¶æ€:', res.status);

                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }

                const data = await res.json();
                console.log('APIè¿”å›æ•°æ®:', data);

                // æ£€æŸ¥æ•°æ®ç»“æ„
                if (!data || typeof data !== 'object') {
                    throw new Error('APIè¿”å›æ•°æ®æ ¼å¼é”™è¯¯');
                }

                // è·å–ä¸­å¿ƒç”¨æˆ·ä¿¡æ¯
                const center = data.center;
                if (!center || typeof center !== 'object') {
                    throw new Error('ç”¨æˆ·ä¸­å¿ƒæ•°æ®ä¸å­˜åœ¨');
                }

                console.log('ä¸­å¿ƒç”¨æˆ·:', center);

                // æ˜¾ç¤ºä¸­å¿ƒç”¨æˆ·
                const centerHtml = `
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-lg font-bold text-slate-900">@${center.username || 'æœªçŸ¥'}</p>
                            <p class="text-sm text-slate-600">ID: ${center.telegram_id || 'æœªçŸ¥'}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-slate-600">ä½™é¢: <span class="font-bold text-indigo-600">${center.balance || 0} U</span></p>
                            <p class="text-sm text-slate-600">ç´¯è®¡: <span class="font-bold text-green-600">${center.total_earned || 0} U</span></p>
                        </div>
                    </div>
                    <div class="mt-3">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold ${center.is_vip ? 'bg-purple-100 text-purple-700' : 'bg-slate-100 text-slate-600'}">
                            ${center.is_vip ? 'ğŸ’ VIPä¼šå‘˜' : 'âŒ éVIP'}
                        </span>
                    </div>
                `;
                document.getElementById('centerContent').innerHTML = centerHtml;

                // æ˜¾ç¤ºä¸Šçº§
                const uplines = data.uplines || [];
                console.log('ä¸Šçº§æ•°é‡:', uplines.length);

                if (uplines && uplines.length > 0) {
                    const uplinesHtml = uplines.map(u => {
                        if (!u || typeof u !== 'object') return '';
                        return `
                            <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg border border-slate-200 hover:bg-indigo-50 hover:border-indigo-300 transition">
                                <span class="flex-shrink-0 w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center font-bold text-indigo-700">L${u.level || '?'}</span>
                                <div class="flex-1">
                                    <p class="font-semibold text-slate-900">@${u.username || 'æœªçŸ¥'}</p>
                                    <p class="text-xs text-slate-500">ID: ${u.telegram_id || 'æœªçŸ¥'}</p>
                                </div>
                                <div class="flex gap-2">
                                    <span class="text-lg" title="${u.is_vip ? 'VIP' : 'éVIP'}">${u.is_vip ? 'ğŸ’' : 'âŒ'}</span>
                                </div>
                            </div>
                        `;
                    }).join('');
                    document.getElementById('uplinesContent').innerHTML = uplinesHtml;
                } else {
                    document.getElementById('uplinesContent').innerHTML = '<p class="text-slate-400">æš‚æ— ä¸Šçº§</p>';
                }

                // æ˜¾ç¤ºä¸‹çº§
                const downlines = data.downlines || [];
                console.log('ä¸‹çº§æ•°é‡:', downlines.length);

                if (downlines && downlines.length > 0) {
                    // æŒ‰å±‚çº§åˆ†ç»„
                    const levels = {};
                    downlines.forEach(d => {
                        if (!d || typeof d !== 'object') return;
                        const lvl = d.level || 1;
                        if (!levels[lvl]) levels[lvl] = [];
                        levels[lvl].push(d);
                    });

                    const downlinesHtml = Object.keys(levels).sort((a,b) => a-b).map(level => {
                        const members = levels[level];
                        if (!members || members.length === 0) return '';

                        const membersHtml = members.map(d => {
                            if (!d || typeof d !== 'object') return '';
                            return `
                                <div class="flex items-center gap-3 p-2 bg-slate-50 rounded-lg border border-slate-200 text-sm">
                                    <div class="flex-1">
                                        <p class="font-semibold text-slate-900">@${d.username || 'æœªçŸ¥'}</p>
                                    </div>
                                    <div class="flex gap-1">
                                        <span title="${d.is_vip ? 'VIP' : 'éVIP'}">${d.is_vip ? 'ğŸ’' : 'âŒ'}</span>
                                    </div>
                                </div>
                            `;
                        }).join('');

                        return `
                            <div class="mb-4">
                                <h3 class="text-sm font-bold text-slate-700 mb-2">ç¬¬${level}å±‚ (${members.length}äºº)</h3>
                                <div class="space-y-2">
                                    ${membersHtml}
                                </div>
                            </div>
                        `;
                    }).join('');

                    document.getElementById('downlinesContent').innerHTML = downlinesHtml;
                } else {
                    document.getElementById('downlinesContent').innerHTML = '<p class="text-slate-400">æš‚æ— ä¸‹çº§</p>';
                }

                console.log('å›¾è°±åŠ è½½å®Œæˆ');

            } catch (error) {
                console.error('å›¾è°±åŠ è½½å¤±è´¥:', error);

                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                const errorHtml = `<div class="text-red-500 p-4 bg-red-50 rounded-lg border border-red-200">
                    <h3 class="font-bold mb-2">æ•°æ®åŠ è½½å¤±è´¥</h3>
                    <p class="text-sm">${error.message}</p>
                    <p class="text-xs mt-2 text-gray-500">è¯·åˆ·æ–°é¡µé¢é‡è¯•æˆ–è”ç³»ç®¡ç†å‘˜</p>
                </div>`;

                document.getElementById('centerContent').innerHTML = errorHtml;
                document.getElementById('uplinesContent').innerHTML = '';
                document.getElementById('downlinesContent').innerHTML = '';
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åŠ è½½å›¾è°±æ•°æ®');
            loadGraph();
        });
    </script>
{% endblock %}
