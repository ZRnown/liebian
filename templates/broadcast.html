{% extends "base.html" %}

{% block title %}ç¾¤å‘ç®¡ç†{% endblock %}

{% block content %}
<main class="px-4 py-6">
    <div class="mb-6 flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-slate-900">ç¾¤å‘ç®¡ç†</h1>
            <p class="text-slate-500 text-sm mt-1">ç®¡ç†ç¾¤å‘å†…å®¹ï¼Œæ”¯æŒå®šæ—¶å‘é€å’ŒæŒ‰é’®è®¾ç½®</p>
        </div>
        <button onclick="showAddModal()" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium">
            <i class="ti ti-plus"></i> æ·»åŠ ç¾¤å‘å†…å®¹
        </button>
    </div>


    <!-- ç¾¤å‘å†…å®¹åˆ—è¡¨ -->
    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-slate-100 text-slate-600 font-semibold">
                    <tr>
                        <th class="px-4 py-3 text-left">ID</th>
                        <th class="px-4 py-3 text-left">åç§°</th>
                        <th class="px-4 py-3 text-left">å†…å®¹é¢„è§ˆ</th>
                        <th class="px-4 py-3 text-center">åª’ä½“</th>
                        <th class="px-4 py-3 text-center">æŒ‰é’®æ•°</th>
                        <th class="px-4 py-3 text-center">çŠ¶æ€</th>
                        <th class="px-4 py-3 text-center">é—´éš”(åˆ†é’Ÿ)</th>
                        <th class="px-4 py-3 text-left">åˆ›å»ºæ—¶é—´</th>
                        <th class="px-4 py-3 text-center">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="messagesList" class="divide-y divide-slate-100">
                    <tr><td colspan="9" class="px-4 py-8 text-center text-slate-400">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</main>

<!-- Toast -->
<div id="toast" class="fixed top-4 right-4 z-[70] transform transition-all duration-300 translate-x-full opacity-0">
    <div class="bg-white rounded-lg shadow-xl border p-3 flex items-center gap-3 min-w-[280px]">
        <div id="toast-icon"></div>
        <div class="flex-1">
            <h4 id="toast-title" class="text-sm font-semibold"></h4>
            <p id="toast-message" class="text-xs text-slate-500 mt-0.5"></p>
        </div>
    </div>
</div>

<!-- æ·»åŠ /ç¼–è¾‘ç¾¤å‘å†…å®¹æ¨¡æ€æ¡† -->
<div id="messageModal" class="modal fixed inset-0 bg-slate-900/50 z-[60] items-center justify-center backdrop-blur-sm hidden">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl m-4 max-h-[90vh] overflow-y-auto">
        <div class="p-4 border-b border-slate-200 flex justify-between items-center">
            <h3 id="modalTitle" class="text-base font-bold text-slate-900">æ·»åŠ ç¾¤å‘å†…å®¹</h3>
            <button onclick="closeModal('messageModal')" class="text-slate-400 hover:text-slate-600"><i class="ti ti-x text-xl"></i></button>
        </div>
        <div class="p-4">
            <input type="hidden" id="editingId">

            <!-- ç¾¤å‘åç§° -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-slate-700 mb-1">ç¾¤å‘åç§°</label>
                <input type="text" id="messageTitle" class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg" placeholder="è¾“å…¥ç¾¤å‘å†…å®¹åç§°..." maxlength="100">
            </div>

            <div class="mb-4">
                <div class="flex items-center justify-between mb-1">
                    <label class="text-sm font-medium text-slate-700">æ–‡æœ¬å†…å®¹</label>
                    <div class="flex gap-2">
                        <button onclick="insertEmoji()" class="px-2 py-1 text-xs bg-yellow-100 hover:bg-yellow-200 text-yellow-700 rounded">ğŸ˜€ è¡¨æƒ…</button>
                        <button onclick="copyContent()" class="px-2 py-1 text-xs bg-slate-100 hover:bg-slate-200 text-slate-700 rounded"><i class="ti ti-copy"></i> å¤åˆ¶</button>
                    </div>
                </div>
                <textarea id="messageContent" rows="5" class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg" placeholder="è¾“å…¥ç¾¤å‘æ–‡æœ¬å†…å®¹..."></textarea>
            </div>
            
            <!-- åª’ä½“è®¾ç½® -->
            <div class="mb-4 grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">æ·»åŠ å›¾ç‰‡</label>
                    <div class="flex gap-2">
                        <input type="file" id="imageFile" accept="image/*" class="hidden" onchange="uploadFile('image')">
                        <input type="text" id="imageUrl" class="flex-1 px-3 py-2 text-sm border border-slate-200 rounded-lg" placeholder="å›¾ç‰‡URLæˆ–ç‚¹å‡»ä¸Šä¼ " readonly>
                        <button type="button" onclick="document.getElementById('imageFile').click()" class="px-3 py-2 text-sm bg-blue-500 text-white rounded-lg hover:bg-blue-600">ä¸Šä¼ </button>
                        <button type="button" onclick="clearFile('image')" class="px-3 py-2 text-sm bg-gray-200 text-gray-600 rounded-lg hover:bg-gray-300">æ¸…é™¤</button>
                    </div>
                    <div id="imagePreview" class="mt-2 hidden"><img class="max-h-32 rounded"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">æ·»åŠ è§†é¢‘</label>
                    <div class="flex gap-2">
                        <input type="file" id="videoFile" accept="video/*" class="hidden" onchange="uploadFile('video')">
                        <input type="text" id="videoUrl" class="flex-1 px-3 py-2 text-sm border border-slate-200 rounded-lg" placeholder="è§†é¢‘URLæˆ–ç‚¹å‡»ä¸Šä¼ " readonly>
                        <button type="button" onclick="document.getElementById('videoFile').click()" class="px-3 py-2 text-sm bg-blue-500 text-white rounded-lg hover:bg-blue-600">ä¸Šä¼ </button>
                        <button type="button" onclick="clearFile('video')" class="px-3 py-2 text-sm bg-gray-200 text-gray-600 rounded-lg hover:bg-gray-300">æ¸…é™¤</button>
                    </div>
                    <div id="videoPreview" class="mt-2 hidden"><video controls class="max-h-32 rounded"></video></div>
                </div>
            </div>
            
            <!-- æŒ‰é’®è®¾ç½® -->
            <div class="mb-4 border-t pt-4">
                <div class="flex items-center justify-between mb-2">
                    <label class="text-sm font-medium text-slate-700">æŒ‰é’®å†…å®¹</label>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-slate-500">æ¯è¡Œåˆ—æ•°:</span>
                        <select id="buttonsPerRow" class="px-2 py-1 text-xs border border-slate-200 rounded">
                            <option value="1">1åˆ—</option>
                            <option value="2" selected>2åˆ—</option>
                            <option value="3">3åˆ—</option>
                            <option value="4">4åˆ—</option>
                        </select>
                        <button onclick="addButton()" class="px-2 py-1 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded">æ·»åŠ æŒ‰é’®</button>
                    </div>
                </div>
                <p class="text-xs text-slate-500 mb-2">ä¸æ·»åŠ ä¸ºçº¯æ–‡æœ¬ï¼Œç‚¹æ·»åŠ å°±å¤šä¸€è¡ŒæŒ‰é’®è®¾ç½®ï¼ŒæŒ‰é’®å¯é€‰æ‹©è¡¨æƒ…</p>
                <div class="text-xs p-2 bg-amber-50 border border-amber-200 rounded mb-2">
                    <div class="font-medium text-amber-700 mb-1">âš ï¸ TelegramæŒ‰é’®é™åˆ¶ï¼š</div>
                    <div class="text-amber-600">â€¢ æ¯è¡Œæœ€å¤š8ä¸ªæŒ‰é’®ï¼Œæ¯æ¡æ¶ˆæ¯æœ€å¤š100ä¸ªæŒ‰é’®</div>
                    <div class="text-amber-600">â€¢ æŒ‰é’®æ–‡å­—æœ€å¤š64å­—ç¬¦</div>
                    <div class="text-amber-600">â€¢ URLå¿…é¡»ä»¥ http:// æˆ– https:// å¼€å¤´ï¼Œæœ€å¤š2048å­—ç¬¦</div>
                </div>
                <div id="buttonsList" class="space-y-2">
                    <!-- åŠ¨æ€æ·»åŠ çš„æŒ‰é’®è¡Œ -->
                </div>
            </div>

            <!-- å®šæ—¶ç¾¤å‘é—´éš”å·²ç§»è‡³åˆ—è¡¨ï¼Œå¯åœ¨åˆ—è¡¨ç›´æ¥è®¾ç½®æ¯æ¡æ¶ˆæ¯çš„é—´éš”ï¼ˆåˆ†é’Ÿï¼‰ -->

            <div class="flex gap-3 pt-2">
                <button onclick="closeModal('messageModal')" class="flex-1 px-4 py-2 text-sm border border-slate-200 text-slate-600 rounded-lg hover:bg-slate-50">å–æ¶ˆ</button>
                <button onclick="previewMessage()" class="px-4 py-2 text-sm bg-purple-500 hover:bg-purple-600 text-white rounded-lg">é¢„è§ˆ</button>
                <button onclick="saveMessage()" class="flex-1 px-4 py-2 text-sm bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium">ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>

<!-- é¢„è§ˆæ¨¡æ€æ¡† -->
<div id="previewModal" class="modal fixed inset-0 bg-slate-900/50 z-[70] items-center justify-center backdrop-blur-sm hidden">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-md m-4">
        <div class="p-4 border-b border-slate-200 flex justify-between items-center">
            <h3 class="text-base font-bold text-slate-900">æ¶ˆæ¯é¢„è§ˆ</h3>
            <button onclick="closeModal('previewModal')" class="text-slate-400 hover:text-slate-600"><i class="ti ti-x text-xl"></i></button>
        </div>
        <div id="previewContent" class="p-4 bg-slate-50">
            <!-- é¢„è§ˆå†…å®¹ -->
        </div>
    </div>
</div>

<!-- è¡¨æƒ…é€‰æ‹©å™¨ -->
<div id="emojiPicker" class="fixed z-[80] bg-white rounded-lg shadow-xl border p-2 hidden" style="width: 280px;">
    <div class="grid grid-cols-8 gap-1 max-h-48 overflow-y-auto text-lg">
    </div>
</div>

<style>
.modal.show { display: flex !important; }
</style>

<script>
let editingId = null;
// æ–‡ä»¶ä¸Šä¼ å‡½æ•°
async function uploadFile(type) {
    const fileInput = document.getElementById(type + 'File');
    const file = fileInput.files[0];
    if (!file) return;
    
    if (file.size > 50 * 1024 * 1024) {
        showToast('é”™è¯¯', 'æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡50MB', 'error');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    formData.append('type', type);
    
    try {
        showToast('ä¸Šä¼ ä¸­', 'æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...');
        const response = await fetch('/api/upload', {
            method: 'POST',
            body: formData
        });
        const result = await response.json();
        
        if (result.success) {
            document.getElementById(type + 'Url').value = result.url;
            const preview = document.getElementById(type + 'Preview');
            preview.classList.remove('hidden');
            if (type === 'image') {
                preview.querySelector('img').src = result.url;
                disableMediaType('video');
            } else {
                preview.querySelector('video').src = result.url;
                disableMediaType('image');
            }
            showToast('æˆåŠŸ', 'æ–‡ä»¶ä¸Šä¼ æˆåŠŸ');
        } else {
            showToast('é”™è¯¯', result.message || 'ä¸Šä¼ å¤±è´¥', 'error');
        }
    } catch (error) {
        showToast('é”™è¯¯', error.message, 'error');
    }
}

function clearFile(type) {
    document.getElementById(type + 'File').value = '';
    document.getElementById(type + 'Url').value = '';
    document.getElementById(type + 'Preview').classList.add('hidden');
    // æ¸…é™¤åæ¢å¤å¦ä¸€ä¸ªåª’ä½“ç±»å‹
    const otherType = type === 'image' ? 'video' : 'image';
    enableMediaType(otherType);
}

// ç¦ç”¨åª’ä½“ç±»å‹å¹¶æ˜¾ç¤ºæç¤º
function disableMediaType(type) {
    const uploadBtn = document.querySelector(`#${type}File`).parentElement.querySelector('button');
    uploadBtn.disabled = true;
    uploadBtn.classList.add('opacity-50', 'cursor-not-allowed');
    uploadBtn.classList.remove('hover:bg-blue-600');
    
    // æ˜¾ç¤ºæç¤º
    showMediaTip();
}

// å¯ç”¨åª’ä½“ç±»å‹
function enableMediaType(type) {
    const uploadBtn = document.querySelector(`#${type}File`).parentElement.querySelector('button');
    uploadBtn.disabled = false;
    uploadBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    uploadBtn.classList.add('hover:bg-blue-600');
}

// æ˜¾ç¤ºåª’ä½“æç¤ºï¼ˆ5ç§’åæ¶ˆå¤±ï¼‰
function showMediaTip() {
    let tip = document.getElementById('mediaTip');
    if (!tip) {
        tip = document.createElement('div');
        tip.id = 'mediaTip';
        tip.className = 'text-xs p-2 bg-blue-50 border border-blue-200 rounded text-blue-700 mt-2';
        tip.innerHTML = 'ğŸ’¡ TGä¸æ”¯æŒåœ¨ä¸€æ¡æ¶ˆæ¯ä¸­åŒæ—¶å‘é€å›¾ç‰‡å’Œè§†é¢‘ï¼Œå•æ¡æ¶ˆæ¯åªèƒ½åŒ…å«ä¸€ç§åª’ä½“';
        document.getElementById('videoPreview').parentElement.after(tip);
    }
    tip.style.display = 'block';
    setTimeout(() => {
        if (tip) tip.style.display = 'none';
    }, 5000);
}

let buttonCount = 0;
const emojis = ['ğŸ˜€','ğŸ˜ƒ','ğŸ˜„','ğŸ˜','ğŸ˜†','ğŸ˜…','ğŸ¤£','ğŸ˜‚','ğŸ™‚','ğŸ˜Š','ğŸ˜‡','ğŸ¥°','ğŸ˜','ğŸ¤©','ğŸ˜˜','ğŸ˜—','ğŸ˜š','ğŸ˜‹','ğŸ˜›','ğŸ˜œ','ğŸ¤ª','ğŸ˜','ğŸ¤‘','ğŸ¤—','ğŸ¤­','ğŸ¤«','ğŸ¤”','ğŸ¤','ğŸ¤¨','ğŸ˜','ğŸ˜‘','ğŸ˜¶','ğŸ˜','ğŸ˜’','ğŸ™„','ğŸ˜¬','ğŸ¤¥','ğŸ˜Œ','ğŸ˜”','ğŸ˜ª','ğŸ¤¤','ğŸ˜´','ğŸ˜·','ğŸ¤’','ğŸ¤•','ğŸ¤¢','ğŸ¤®','ğŸ¤§','ğŸ¥µ','ğŸ¥¶','ğŸ¥´','ğŸ˜µ','ğŸ¤¯','ğŸ¤ ','ğŸ¥³','ğŸ˜','ğŸ¤“','ğŸ§','ğŸ˜•','ğŸ˜Ÿ','ğŸ™','â˜¹ï¸','ğŸ˜®','ğŸ˜¯','ğŸ˜²','ğŸ˜³','ğŸ¥º','ğŸ˜¦','ğŸ˜§','ğŸ˜¨','ğŸ˜°','ğŸ˜¥','ğŸ˜¢','ğŸ˜­','ğŸ˜±','ğŸ˜–','ğŸ˜£','ğŸ˜','ğŸ˜“','ğŸ˜©','ğŸ˜«','ğŸ¥±','ğŸ˜¤','ğŸ˜¡','ğŸ˜ ','ğŸ¤¬','ğŸ˜ˆ','ğŸ‘¿','ğŸ’€','â˜ ï¸','ğŸ’©','ğŸ¤¡','ğŸ‘¹','ğŸ‘º','ğŸ‘»','ğŸ‘½','ğŸ‘¾','ğŸ¤–','ğŸ˜º','ğŸ˜¸','ğŸ˜¹','ğŸ˜»','ğŸ˜¼','ğŸ˜½','ğŸ™€','ğŸ˜¿','ğŸ˜¾','ğŸ™ˆ','ğŸ™‰','ğŸ™Š','ğŸ’‹','ğŸ’Œ','ğŸ’˜','ğŸ’','ğŸ’–','ğŸ’—','ğŸ’“','ğŸ’','ğŸ’•','ğŸ’Ÿ','â£ï¸','ğŸ’”','â¤ï¸','ğŸ§¡','ğŸ’›','ğŸ’š','ğŸ’™','ğŸ’œ','ğŸ¤','ğŸ–¤','ğŸ¤','ğŸ’¯','ğŸ’¢','ğŸ’¥','ğŸ’«','ğŸ’¦','ğŸ’¨','ğŸ•³ï¸','ğŸ’£','ğŸ’¬','ğŸ‘ï¸â€ğŸ—¨ï¸','ğŸ—¨ï¸','ğŸ—¯ï¸','ğŸ’­','ğŸ’¤','ğŸ‘‹','ğŸ¤š','ğŸ–ï¸','âœ‹','ğŸ––','ğŸ‘Œ','ğŸ¤','âœŒï¸','ğŸ¤','ğŸ¤Ÿ','ğŸ¤˜','ğŸ¤™','ğŸ‘ˆ','ğŸ‘‰','ğŸ‘†','ğŸ–•','ğŸ‘‡','â˜ï¸','ğŸ‘','ğŸ‘','âœŠ','ğŸ‘Š','ğŸ¤›','ğŸ¤œ','ğŸ‘','ğŸ™Œ','ğŸ‘','ğŸ¤²','ğŸ¤','ğŸ™','âœï¸','ğŸ’…','ğŸ¤³','ğŸ’ª','ğŸ¦¾','ğŸ¦¿','ğŸ¦µ','ğŸ¦¶','ğŸ‘‚','ğŸ¦»','ğŸ‘ƒ','ğŸ§ ','ğŸ¦·','ğŸ¦´','ğŸ‘€','ğŸ‘ï¸','ğŸ‘…','ğŸ‘„','ğŸ‘¶','ğŸ§’','ğŸ‘¦','ğŸ‘§','ğŸ§‘','ğŸ‘±','ğŸ‘¨','ğŸ§”','ğŸ‘©','ğŸ§“','ğŸ‘´','ğŸ‘µ','ğŸ™','ğŸ™','ğŸ™…','ğŸ™†','ğŸ’','ğŸ™‹','ğŸ§','ğŸ™‡','ğŸ¤¦','ğŸ¤·','ğŸ‘®','ğŸ•µï¸','ğŸ’‚','ğŸ‘·','ğŸ¤´','ğŸ‘¸','ğŸ‘³','ğŸ‘²','ğŸ§•','ğŸ¤µ','ğŸ‘°','ğŸ¤°','ğŸ¤±','ğŸ‘¼','ğŸ…','ğŸ¤¶','ğŸ¦¸','ğŸ¦¹','ğŸ§™','ğŸ§š','ğŸ§›','ğŸ§œ','ğŸ§','ğŸ§','ğŸ§Ÿ','ğŸ’†','ğŸ’‡','ğŸš¶','ğŸ§','ğŸ§','ğŸƒ','ğŸ’ƒ','ğŸ•º','ğŸ•´ï¸','ğŸ‘¯','ğŸ§–','ğŸ§—','ğŸ¤¸','ğŸŒï¸','ğŸ‡','â›·ï¸','ğŸ‚','ğŸ‹ï¸','ğŸ¤¼','ğŸ¤½','ğŸ¤¾','ğŸ¤º','â›¹ï¸','ğŸŠ','ğŸš£','ğŸ§˜','ğŸ›€','ğŸ›Œ','ğŸ‘­','ğŸ‘«','ğŸ‘¬','ğŸ’','ğŸ’‘','ğŸ‘ª','ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦','ğŸ‘¨â€ğŸ‘©â€ğŸ‘§','ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦','ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦â€ğŸ‘¦','ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘§','ğŸ‘¨â€ğŸ‘¦','ğŸ‘¨â€ğŸ‘¦â€ğŸ‘¦','ğŸ‘¨â€ğŸ‘§','ğŸ‘¨â€ğŸ‘§â€ğŸ‘¦','ğŸ‘¨â€ğŸ‘§â€ğŸ‘§','ğŸ‘©â€ğŸ‘¦','ğŸ‘©â€ğŸ‘¦â€ğŸ‘¦','ğŸ‘©â€ğŸ‘§','ğŸ‘©â€ğŸ‘§â€ğŸ‘¦','ğŸ‘©â€ğŸ‘§â€ğŸ‘§','ğŸ—£ï¸','ğŸ‘¤','ğŸ‘¥','ğŸ‘£','ğŸµ','ğŸ’','ğŸ¦','ğŸ¦§','ğŸ¶','ğŸ•','ğŸ¦®','ğŸ•â€ğŸ¦º','ğŸ©','ğŸº','ğŸ¦Š','ğŸ¦','ğŸ±','ğŸˆ','ğŸ¦','ğŸ¯','ğŸ…','ğŸ†','ğŸ´','ğŸ','ğŸ¦„','ğŸ¦“','ğŸ¦Œ','ğŸ®','ğŸ‚','ğŸƒ','ğŸ„','ğŸ·','ğŸ–','ğŸ—','ğŸ½','ğŸ','ğŸ‘','ğŸ','ğŸª','ğŸ«','ğŸ¦™','ğŸ¦’','ğŸ˜','ğŸ¦','ğŸ¦›','ğŸ­','ğŸ','ğŸ€','ğŸ¹','ğŸ°','ğŸ‡','ğŸ¿ï¸','ğŸ¦”','ğŸ¦‡','ğŸ»','ğŸ¨','ğŸ¼','ğŸ¦¥','ğŸ¦¦','ğŸ¦¨','ğŸ¦˜','ğŸ¦¡','ğŸ¾','ğŸ¦ƒ','ğŸ”','ğŸ“','ğŸ£','ğŸ¤','ğŸ¥','ğŸ¦','ğŸ§','ğŸ•Šï¸','ğŸ¦…','ğŸ¦†','ğŸ¦¢','ğŸ¦‰','ğŸ¦©','ğŸ¦š','ğŸ¦œ','ğŸ¸','ğŸŠ','ğŸ¢','ğŸ¦','ğŸ','ğŸ²','ğŸ‰','ğŸ¦•','ğŸ¦–','ğŸ³','ğŸ‹','ğŸ¬','ğŸŸ','ğŸ ','ğŸ¡','ğŸ¦ˆ','ğŸ™','ğŸš','ğŸŒ','ğŸ¦‹','ğŸ›','ğŸœ','ğŸ','ğŸ','ğŸ¦—','ğŸ¦Ÿ','ğŸ¦ ','ğŸ’','ğŸŒ¸','ğŸ’®','ğŸµï¸','ğŸŒ¹','ğŸ¥€','ğŸŒº','ğŸŒ»','ğŸŒ¼','ğŸŒ·','ğŸŒ±','ğŸŒ²','ğŸŒ³','ğŸŒ´','ğŸŒµ','ğŸŒ¾','ğŸŒ¿','â˜˜ï¸','ğŸ€','ğŸ','ğŸ‚','ğŸƒ','ğŸ‡','ğŸˆ','ğŸ‰','ğŸŠ','ğŸ‹','ğŸŒ','ğŸ','ğŸ¥­','ğŸ','ğŸ','ğŸ','ğŸ‘','ğŸ’','ğŸ“','ğŸ¥','ğŸ…','ğŸ¥¥','ğŸ¥‘','ğŸ†','ğŸ¥”','ğŸ¥•','ğŸŒ½','ğŸŒ¶ï¸','ğŸ¥’','ğŸ¥¬','ğŸ¥¦','ğŸ§„','ğŸ§…','ğŸ„','ğŸ¥œ','ğŸŒ°','ğŸ','ğŸ¥','ğŸ¥–','ğŸ¥¨','ğŸ¥¯','ğŸ¥','ğŸ§‡','ğŸ§€','ğŸ–','ğŸ—','ğŸ¥©','ğŸ¥“','ğŸ”','ğŸŸ','ğŸ•','ğŸŒ­','ğŸ¥ª','ğŸŒ®','ğŸŒ¯','ğŸ¥™','ğŸ§†','ğŸ¥š','ğŸ³','ğŸ¥˜','ğŸ²','ğŸ¥£','ğŸ¥—','ğŸ¿','ğŸ§ˆ','ğŸ§‚','ğŸ¥«','ğŸ±','ğŸ˜','ğŸ™','ğŸš','ğŸ›','ğŸœ','ğŸ','ğŸ ','ğŸ¢','ğŸ£','ğŸ¤','ğŸ¥','ğŸ¥®','ğŸ¡','ğŸ¥Ÿ','ğŸ¥ ','ğŸ¥¡','ğŸ¦€','ğŸ¦','ğŸ¦','ğŸ¦‘','ğŸ¦ª','ğŸ¦','ğŸ§','ğŸ¨','ğŸ©','ğŸª','ğŸ‚','ğŸ°','ğŸ§','ğŸ¥§','ğŸ«','ğŸ¬','ğŸ­','ğŸ®','ğŸ¯','ğŸ¼','ğŸ¥›','â˜•','ğŸµ','ğŸ¶','ğŸ¾','ğŸ·','ğŸ¸','ğŸ¹','ğŸº','ğŸ»','ğŸ¥‚','ğŸ¥ƒ','ğŸ¥¤','ğŸ§ƒ','ğŸ§‰','ğŸ§Š','ğŸ¥¢','ğŸ½ï¸','ğŸ´','ğŸ¥„','ğŸ”ª','ğŸº','ğŸŒ','ğŸŒ','ğŸŒ','ğŸŒ','ğŸ—ºï¸','ğŸ§­','ğŸ”ï¸','â›°ï¸','ğŸŒ‹','ğŸ—»','ğŸ•ï¸','ğŸ–ï¸','ğŸœï¸','ğŸï¸','ğŸï¸','ğŸŸï¸','ğŸ›ï¸','ğŸ—ï¸','ğŸ§±','ğŸ˜ï¸','ğŸšï¸','ğŸ ','ğŸ¡','ğŸ¢','ğŸ£','ğŸ¤','ğŸ¥','ğŸ¦','ğŸ¨','ğŸ©','ğŸª','ğŸ«','ğŸ¬','ğŸ­','ğŸ¯','ğŸ°','ğŸ’’','ğŸ—¼','ğŸ—½','â›ª','ğŸ•Œ','ğŸ›•','ğŸ•','â›©ï¸','ğŸ•‹','â›²','â›º','ğŸŒ','ğŸŒƒ','ğŸ™ï¸','ğŸŒ„','ğŸŒ…','ğŸŒ†','ğŸŒ‡','ğŸŒ‰','â™¨ï¸','ğŸ ','ğŸ¡','ğŸ¢','ğŸ’ˆ','ğŸª','ğŸš‚','ğŸšƒ','ğŸš„','ğŸš…','ğŸš†','ğŸš‡','ğŸšˆ','ğŸš‰','ğŸšŠ','ğŸš','ğŸš','ğŸš‹','ğŸšŒ','ğŸš','ğŸš','ğŸš','ğŸš‘','ğŸš’','ğŸš“','ğŸš”','ğŸš•','ğŸš–','ğŸš—','ğŸš˜','ğŸš™','ğŸšš','ğŸš›','ğŸšœ','ğŸï¸','ğŸï¸','ğŸ›µ','ğŸ¦½','ğŸ¦¼','ğŸ›º','ğŸš²','ğŸ›´','ğŸ›¹','ğŸš','ğŸ›£ï¸','ğŸ›¤ï¸','ğŸ›¢ï¸','â›½','ğŸš¨','ğŸš¥','ğŸš¦','ğŸ›‘','ğŸš§','âš“','â›µ','ğŸ›¶','ğŸš¤','ğŸ›³ï¸','â›´ï¸','ğŸ›¥ï¸','ğŸš¢','âœˆï¸','ğŸ›©ï¸','ğŸ›«','ğŸ›¬','ğŸª‚','ğŸ’º','ğŸš','ğŸšŸ','ğŸš ','ğŸš¡','ğŸ›°ï¸','ğŸš€','ğŸ›¸','ğŸ›ï¸','ğŸ§³','âŒ›','â³','âŒš','â°','â±ï¸','â²ï¸','ğŸ•°ï¸','ğŸ•›','ğŸ•§','ğŸ•','ğŸ•œ','ğŸ•‘','ğŸ•','ğŸ•’','ğŸ•','ğŸ•“','ğŸ•Ÿ','ğŸ•”','ğŸ• ','ğŸ••','ğŸ•¡','ğŸ•–','ğŸ•¢','ğŸ•—','ğŸ•£','ğŸ•˜','ğŸ•¤','ğŸ•™','ğŸ•¥','ğŸ•š','ğŸ•¦','ğŸŒ‘','ğŸŒ’','ğŸŒ“','ğŸŒ”','ğŸŒ•','ğŸŒ–','ğŸŒ—','ğŸŒ˜','ğŸŒ™','ğŸŒš','ğŸŒ›','ğŸŒœ','ğŸŒ¡ï¸','â˜€ï¸','ğŸŒ','ğŸŒ','ğŸª','â­','ğŸŒŸ','ğŸŒ ','ğŸŒŒ','â˜ï¸','â›…','â›ˆï¸','ğŸŒ¤ï¸','ğŸŒ¥ï¸','ğŸŒ¦ï¸','ğŸŒ§ï¸','ğŸŒ¨ï¸','ğŸŒ©ï¸','ğŸŒªï¸','ğŸŒ«ï¸','ğŸŒ¬ï¸','ğŸŒ€','ğŸŒˆ','ğŸŒ‚','â˜‚ï¸','â˜”','â›±ï¸','âš¡','â„ï¸','â˜ƒï¸','â›„','â˜„ï¸','ğŸ”¥','ğŸ’§','ğŸŒŠ','ğŸƒ','ğŸ„','ğŸ†','ğŸ‡','ğŸ§¨','âœ¨','ğŸˆ','ğŸ‰','ğŸŠ','ğŸ‹','ğŸ','ğŸ','ğŸ','ğŸ','ğŸ‘','ğŸ§§','ğŸ€','ğŸ','ğŸ—ï¸','ğŸŸï¸','ğŸ«','ğŸ–ï¸','ğŸ†','ğŸ…','ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','âš½','âš¾','ğŸ¥','ğŸ€','ğŸ','ğŸˆ','ğŸ‰','ğŸ¾','ğŸ¥','ğŸ³','ğŸ','ğŸ‘','ğŸ’','ğŸ¥','ğŸ“','ğŸ¸','ğŸ¥Š','ğŸ¥‹','ğŸ¥…','â›³','â›¸ï¸','ğŸ£','ğŸ¤¿','ğŸ½','ğŸ¿','ğŸ›·','ğŸ¥Œ','ğŸ¯','ğŸª€','ğŸª','ğŸ±','ğŸ”®','ğŸ§¿','ğŸ®','ğŸ•¹ï¸','ğŸ°','ğŸ²','ğŸ§©','ğŸ§¸','â™ ï¸','â™¥ï¸','â™¦ï¸','â™£ï¸','â™Ÿï¸','ğŸƒ','ğŸ€„','ğŸ´','ğŸ­','ğŸ–¼ï¸','ğŸ¨','ğŸ§µ','ğŸ§¶','ğŸ‘“','ğŸ•¶ï¸','ğŸ¥½','ğŸ¥¼','ğŸ¦º','ğŸ‘”','ğŸ‘•','ğŸ‘–','ğŸ§£','ğŸ§¤','ğŸ§¥','ğŸ§¦','ğŸ‘—','ğŸ‘˜','ğŸ¥»','ğŸ©±','ğŸ©²','ğŸ©³','ğŸ‘™','ğŸ‘š','ğŸ‘›','ğŸ‘œ','ğŸ‘','ğŸ›ï¸','ğŸ’','ğŸ‘','ğŸ‘Ÿ','ğŸ¥¾','ğŸ¥¿','ğŸ‘ ','ğŸ‘¡','ğŸ©°','ğŸ‘¢','ğŸ‘‘','ğŸ‘’','ğŸ©','ğŸ“','ğŸ§¢','â›‘ï¸','ğŸ“¿','ğŸ’„','ğŸ’','ğŸ’','ğŸ”‡','ğŸ”ˆ','ğŸ”‰','ğŸ”Š','ğŸ“¢','ğŸ“£','ğŸ“¯','ğŸ””','ğŸ”•','ğŸ¼','ğŸµ','ğŸ¶','ğŸ™ï¸','ğŸšï¸','ğŸ›ï¸','ğŸ¤','ğŸ§','ğŸ“»','ğŸ·','ğŸ¸','ğŸ¹','ğŸº','ğŸ»','ğŸª•','ğŸ¥','ğŸ“±','ğŸ“²','â˜ï¸','ğŸ“','ğŸ“Ÿ','ğŸ“ ','ğŸ”‹','ğŸ”Œ','ğŸ’»','ğŸ–¥ï¸','ğŸ–¨ï¸','âŒ¨ï¸','ğŸ–±ï¸','ğŸ–²ï¸','ğŸ’½','ğŸ’¾','ğŸ’¿','ğŸ“€','ğŸ§®','ğŸ¥','ğŸï¸','ğŸ“½ï¸','ğŸ¬','ğŸ“º','ğŸ“·','ğŸ“¸','ğŸ“¹','ğŸ“¼','ğŸ”','ğŸ”','ğŸ•¯ï¸','ğŸ’¡','ğŸ”¦','ğŸ®','ğŸª”','ğŸ“”','ğŸ“•','ğŸ“–','ğŸ“—','ğŸ“˜','ğŸ“™','ğŸ“š','ğŸ““','ğŸ“’','ğŸ“ƒ','ğŸ“œ','ğŸ“„','ğŸ“°','ğŸ—ï¸','ğŸ“‘','ğŸ”–','ğŸ·ï¸','ğŸ’°','ğŸ’´','ğŸ’µ','ğŸ’¶','ğŸ’·','ğŸ’¸','ğŸ’³','ğŸ§¾','ğŸ’¹','âœ‰ï¸','ğŸ“§','ğŸ“¨','ğŸ“©','ğŸ“¤','ğŸ“¥','ğŸ“¦','ğŸ“«','ğŸ“ª','ğŸ“¬','ğŸ“­','ğŸ“®','ğŸ—³ï¸','âœï¸','âœ’ï¸','ğŸ–‹ï¸','ğŸ–Šï¸','ğŸ–Œï¸','ğŸ–ï¸','ğŸ“','ğŸ’¼','ğŸ“','ğŸ“‚','ğŸ—‚ï¸','ğŸ“…','ğŸ“†','ğŸ—’ï¸','ğŸ—“ï¸','ğŸ“‡','ğŸ“ˆ','ğŸ“‰','ğŸ“Š','ğŸ“‹','ğŸ“Œ','ğŸ“','ğŸ“','ğŸ–‡ï¸','ğŸ“','ğŸ“','âœ‚ï¸','ğŸ—ƒï¸','ğŸ—„ï¸','ğŸ—‘ï¸','ğŸ”’','ğŸ”“','ğŸ”','ğŸ”','ğŸ”‘','ğŸ—ï¸','ğŸ”¨','ğŸª“','â›ï¸','âš’ï¸','ğŸ› ï¸','ğŸ—¡ï¸','âš”ï¸','ğŸ”«','ğŸ¹','ğŸ›¡ï¸','ğŸ”§','ğŸ”©','âš™ï¸','ğŸ—œï¸','âš–ï¸','ğŸ¦¯','ğŸ”—','â›“ï¸','ğŸ§°','ğŸ§²','âš—ï¸','ğŸ§ª','ğŸ§«','ğŸ§¬','ğŸ”¬','ğŸ”­','ğŸ“¡','ğŸ’‰','ğŸ©¸','ğŸ’Š','ğŸ©¹','ğŸ©º','ğŸšª','ğŸ›ï¸','ğŸ›‹ï¸','ğŸª‘','ğŸš½','ğŸš¿','ğŸ›','ğŸª’','ğŸ§´','ğŸ§·','ğŸ§¹','ğŸ§º','ğŸ§»','ğŸ§¼','ğŸ§½','ğŸ§¯','ğŸ›’','ğŸš¬','âš°ï¸','âš±ï¸','ğŸ—¿','ğŸ§','ğŸš®','ğŸš°','â™¿','ğŸš¹','ğŸšº','ğŸš»','ğŸš¼','ğŸš¾','ğŸ›‚','ğŸ›ƒ','ğŸ›„','ğŸ›…','âš ï¸','ğŸš¸','â›”','ğŸš«','ğŸš³','ğŸš­','ğŸš¯','ğŸš±','ğŸš·','ğŸ“µ','ğŸ”','â˜¢ï¸','â˜£ï¸','â¬†ï¸','â†—ï¸','â¡ï¸','â†˜ï¸','â¬‡ï¸','â†™ï¸','â¬…ï¸','â†–ï¸','â†•ï¸','â†”ï¸','â†©ï¸','â†ªï¸','â¤´ï¸','â¤µï¸','ğŸ”ƒ','ğŸ”„','ğŸ”™','ğŸ”š','ğŸ”›','ğŸ”œ','ğŸ”','ğŸ›','âš›ï¸','ğŸ•‰ï¸','âœ¡ï¸','â˜¸ï¸','â˜¯ï¸','âœï¸','â˜¦ï¸','â˜ªï¸','â˜®ï¸','ğŸ•','ğŸ”¯','â™ˆ','â™‰','â™Š','â™‹','â™Œ','â™','â™','â™','â™','â™‘','â™’','â™“','â›','ğŸ”€','ğŸ”','ğŸ”‚','â–¶ï¸','â©','â­ï¸','â¯ï¸','â—€ï¸','âª','â®ï¸','ğŸ”¼','â«','ğŸ”½','â¬','â¸ï¸','â¹ï¸','âºï¸','âï¸','ğŸ¦','ğŸ”…','ğŸ”†','ğŸ“¶','ğŸ“³','ğŸ“´','â™€ï¸','â™‚ï¸','âš§','âœ–ï¸','â•','â–','â—','â™¾ï¸','â€¼ï¸','â‰ï¸','â“','â”','â•','â—','ã€°ï¸','ğŸ’±','ğŸ’²','âš•ï¸','â™»ï¸','âšœï¸','ğŸ”±','ğŸ“›','ğŸ”°','â­•','âœ…','â˜‘ï¸','âœ”ï¸','âŒ','â','â°','â¿','ã€½ï¸','âœ³ï¸','âœ´ï¸','â‡ï¸','Â©ï¸','Â®ï¸','â„¢ï¸','#ï¸âƒ£','*ï¸âƒ£','0ï¸âƒ£','1ï¸âƒ£','2ï¸âƒ£','3ï¸âƒ£','4ï¸âƒ£','5ï¸âƒ£','6ï¸âƒ£','7ï¸âƒ£','8ï¸âƒ£','9ï¸âƒ£','ğŸ”Ÿ','ğŸ” ','ğŸ”¡','ğŸ”¢','ğŸ”£','ğŸ”¤','ğŸ…°ï¸','ğŸ†','ğŸ…±ï¸','ğŸ†‘','ğŸ†’','ğŸ†“','â„¹ï¸','ğŸ†”','â“‚ï¸','ğŸ†•','ğŸ†–','ğŸ…¾ï¸','ğŸ†—','ğŸ…¿ï¸','ğŸ†˜','ğŸ†™','ğŸ†š','ğŸˆ','ğŸˆ‚ï¸','ğŸˆ·ï¸','ğŸˆ¶','ğŸˆ¯','ğŸ‰','ğŸˆ¹','ğŸˆš','ğŸˆ²','ğŸ‰‘','ğŸˆ¸','ğŸˆ´','ğŸˆ³','ãŠ—ï¸','ãŠ™ï¸','ğŸˆº','ğŸˆµ','ğŸ”´','ğŸŸ ','ğŸŸ¡','ğŸŸ¢','ğŸ”µ','ğŸŸ£','ğŸŸ¤','âš«','âšª','ğŸŸ¥','ğŸŸ§','ğŸŸ¨','ğŸŸ©','ğŸŸ¦','ğŸŸª','ğŸŸ«','â¬›','â¬œ','â—¼ï¸','â—»ï¸','â—¾','â—½','â–ªï¸','â–«ï¸','ğŸ”¶','ğŸ”·','ğŸ”¸','ğŸ”¹','ğŸ”º','ğŸ”»','ğŸ’ ','ğŸ”˜','ğŸ”³','ğŸ”²','ğŸ','ğŸš©','ğŸŒ','ğŸ´','ğŸ³ï¸','ğŸ³ï¸â€ğŸŒˆ','ğŸ´â€â˜ ï¸','ğŸ‡¦ğŸ‡¨','ğŸ‡¦ğŸ‡©','ğŸ‡¦ğŸ‡ª','ğŸ‡¦ğŸ‡«','ğŸ‡¦ğŸ‡¬','ğŸ‡¦ğŸ‡®','ğŸ‡¦ğŸ‡±','ğŸ‡¦ğŸ‡²','ğŸ‡¦ğŸ‡´','ğŸ‡¦ğŸ‡¶','ğŸ‡¦ğŸ‡·','ğŸ‡¦ğŸ‡¸','ğŸ‡¦ğŸ‡¹','ğŸ‡¦ğŸ‡º','ğŸ‡¦ğŸ‡¼','ğŸ‡¦ğŸ‡½','ğŸ‡¦ğŸ‡¿','ğŸ‡§ğŸ‡¦','ğŸ‡§ğŸ‡§','ğŸ‡§ğŸ‡©','ğŸ‡§ğŸ‡ª','ğŸ‡§ğŸ‡«','ğŸ‡§ğŸ‡¬','ğŸ‡§ğŸ‡­','ğŸ‡§ğŸ‡®','ğŸ‡§ğŸ‡¯','ğŸ‡§ğŸ‡±','ğŸ‡§ğŸ‡²','ğŸ‡§ğŸ‡³','ğŸ‡§ğŸ‡´','ğŸ‡§ğŸ‡¶','ğŸ‡§ğŸ‡·','ğŸ‡§ğŸ‡¸','ğŸ‡§ğŸ‡¹','ğŸ‡§ğŸ‡»','ğŸ‡§ğŸ‡¼','ğŸ‡§ğŸ‡¾','ğŸ‡§ğŸ‡¿','ğŸ‡¨ğŸ‡¦','ğŸ‡¨ğŸ‡¨','ğŸ‡¨ğŸ‡©','ğŸ‡¨ğŸ‡«','ğŸ‡¨ğŸ‡¬','ğŸ‡¨ğŸ‡­','ğŸ‡¨ğŸ‡®','ğŸ‡¨ğŸ‡°','ğŸ‡¨ğŸ‡±','ğŸ‡¨ğŸ‡²','ğŸ‡¨ğŸ‡³'];

function showToast(title, message, type = 'success') {
    const toast = document.getElementById('toast');
    document.getElementById('toast-title').textContent = title;
    document.getElementById('toast-message').textContent = message;
    document.getElementById('toast-icon').innerHTML = type === 'success'
        ? '<div class="h-7 w-7 rounded-full bg-green-50 flex items-center justify-center"><i class="ti ti-check text-green-600"></i></div>'
        : '<div class="h-7 w-7 rounded-full bg-red-50 flex items-center justify-center"><i class="ti ti-alert-triangle text-red-600"></i></div>';
    toast.classList.remove('translate-x-full', 'opacity-0');
    setTimeout(() => toast.classList.add('translate-x-full', 'opacity-0'), 3000);
}

async function loadMessages() {
    try {
        const response = await fetch('/api/broadcast/messages');
        const data = await response.json();
        displayMessages(data.messages || []);
    } catch (error) {
        document.getElementById('messagesList').innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-red-500">åŠ è½½å¤±è´¥</td></tr>';
    }
}

function displayMessages(messages) {
    if (!messages || messages.length === 0) {
        document.getElementById('messagesList').innerHTML = '<tr><td colspan="9" class="px-4 py-8 text-center text-slate-400">æš‚æ— ç¾¤å‘å†…å®¹ï¼Œç‚¹å‡»\"æ·»åŠ ç¾¤å‘å†…å®¹\"åˆ›å»º</td></tr>';
        return;
    }

    const html = messages.map(m => {
        const buttons = m.buttons ? JSON.parse(m.buttons || '[]') : [];
        const hasMedia = m.image_url || m.video_url;
        return `
        <tr class="hover:bg-slate-50">
            <td class="px-4 py-3">${m.id}</td>
            <td class="px-4 py-3 font-medium text-slate-900">${m.title || 'æœªå‘½å'}</td>
            <td class="px-4 py-3 text-slate-600 max-w-xs truncate">${(m.content || '').substring(0, 40)}...</td>
            <td class="px-4 py-3 text-center">
                ${hasMedia ? '<span class="text-green-600"><i class="ti ti-photo"></i></span>' : '<span class="text-slate-300">-</span>'}
            </td>
            <td class="px-4 py-3 text-center">${buttons.length}</td>
            <td class="px-4 py-3 text-center">${m.is_active ? '<span class="text-green-600">å¯ç”¨</span>' : '<span class="text-slate-400">åœç”¨</span>'}</td>
            <td class="px-4 py-3 text-center">
                <div class="flex items-center justify-center gap-2">
                    <input id="interval_${m.id}" type="number" min="0" value="${m.broadcast_interval || 0}" class="w-20 px-2 py-1 text-sm border border-slate-200 rounded text-center">
                    <button onclick="saveInterval(${m.id})" class="px-2 py-1 text-xs rounded bg-indigo-500 hover:bg-indigo-600 text-white font-medium">ä¿å­˜</button>
                </div>
            </td>
            <td class="px-4 py-3 text-slate-500">${m.create_time ? m.create_time.split(' ')[0] : '-'}</td>
            <td class="px-4 py-3">
                <div class="flex items-center justify-center gap-1">
                    <button onclick="editMessage(${m.id})" class="px-2 py-1 text-xs rounded bg-blue-500 hover:bg-blue-600 text-white font-medium">ç¼–è¾‘</button>
                    <button onclick="deleteMessage(${m.id})" class="px-2 py-1 text-xs rounded bg-red-500 hover:bg-red-600 text-white font-medium">åˆ é™¤</button>
                </div>
            </td>
        </tr>`;
    }).join('');
    document.getElementById('messagesList').innerHTML = html;
}

function showAddModal() {
    editingId = null;
    buttonCount = 0;
    document.getElementById('modalTitle').textContent = 'æ·»åŠ ç¾¤å‘å†…å®¹';
    document.getElementById('editingId').value = '';

    document.getElementById('messageTitle').value = '';
    document.getElementById('messageContent').value = '';
    document.getElementById('imageUrl').value = '';
    document.getElementById('videoUrl').value = '';
    document.getElementById('imagePreview').classList.add('hidden');
    document.getElementById('videoPreview').classList.add('hidden');
    document.getElementById('buttonsPerRow').value = '2';
    document.getElementById('buttonsList').innerHTML = '';
    // broadcastInterval removed from modal; interval is set in list
    showModal('messageModal');
}

function addButton() {
    buttonCount++;
    const div = document.createElement('div');
    div.className = 'flex items-center gap-2 p-2 bg-slate-50 rounded-lg';
    div.id = `button-row-${buttonCount}`;
    div.innerHTML = `
        <button type="button" onclick="showEmojiPickerFor('btn-name-${buttonCount}')" class="px-2 py-1 text-xs bg-yellow-100 hover:bg-yellow-200 rounded">ğŸ˜€</button>
        <input type="text" id="btn-name-${buttonCount}" placeholder="æŒ‰é’®åç§°" class="flex-1 px-2 py-1.5 text-sm border border-slate-200 rounded">
        <input type="text" id="btn-url-${buttonCount}" placeholder="URLé“¾æ¥" class="flex-1 px-2 py-1.5 text-sm border border-slate-200 rounded">
        <button type="button" onclick="removeButton(${buttonCount})" class="px-2 py-1 text-xs bg-red-100 hover:bg-red-200 text-red-600 rounded">åˆ é™¤</button>
    `;
    document.getElementById('buttonsList').appendChild(div);
}

function removeButton(id) {
    const row = document.getElementById(`button-row-${id}`);
    if (row) row.remove();
}

function getButtons() {
    const buttons = [];
    document.querySelectorAll('#buttonsList > div').forEach(row => {
        const nameInput = row.querySelector('input[id^="btn-name-"]');
        const urlInput = row.querySelector('input[id^="btn-url-"]');
        if (nameInput && urlInput && nameInput.value.trim()) {
            let url = urlInput.value.trim();
            // éªŒè¯URLæ ¼å¼
            if (url && !url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'https://' + url;
            }
            if (url) {
                buttons.push({ name: nameInput.value.trim(), url: url });
            }
        }
    });
    return buttons;
}

function insertEmoji() {
    showEmojiPickerFor('messageContent');
}

let currentEmojiTarget = null;
function showEmojiPickerFor(targetId) {
    currentEmojiTarget = targetId;
    const picker = document.getElementById('emojiPicker');
    const target = document.getElementById(targetId);
    const rect = target.getBoundingClientRect();
    
    picker.style.left = rect.left + 'px';
    picker.style.top = (rect.bottom + 5) + 'px';
    
    picker.querySelector('.grid').innerHTML = emojis.slice(0, 200).map(e => 
        `<button type="button" onclick="insertEmojiChar('${e}')" class="p-1 hover:bg-slate-100 rounded">${e}</button>`
    ).join('');
    
    picker.classList.remove('hidden');
    
    setTimeout(() => {
        document.addEventListener('click', hideEmojiPicker);
    }, 100);
}

function hideEmojiPicker(e) {
    if (!e.target.closest('#emojiPicker')) {
        document.getElementById('emojiPicker').classList.add('hidden');
        document.removeEventListener('click', hideEmojiPicker);
    }
}

function insertEmojiChar(emoji) {
    const target = document.getElementById(currentEmojiTarget);
    if (target.tagName === 'TEXTAREA' || target.tagName === 'INPUT') {
        const start = target.selectionStart;
        const end = target.selectionEnd;
        target.value = target.value.substring(0, start) + emoji + target.value.substring(end);
        target.selectionStart = target.selectionEnd = start + emoji.length;
        target.focus();
    }
    document.getElementById('emojiPicker').classList.add('hidden');
}

function copyContent() {
    const content = document.getElementById('messageContent').value;
    navigator.clipboard.writeText(content);
    showToast('å·²å¤åˆ¶', 'å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
}

function previewMessage() {
    const content = document.getElementById('messageContent').value;
    const imageUrl = document.getElementById('imageUrl').value;
    const buttons = getButtons();
    const perRow = parseInt(document.getElementById('buttonsPerRow').value);
    
    let html = '<div class="bg-white rounded-lg border p-4">';
    if (imageUrl) {
        html += `<img src="${imageUrl}" class="w-full rounded-lg mb-3" onerror="this.style.display='none'">`;
    }
    html += `<p class="text-sm whitespace-pre-wrap">${content}</p>`;
    
    if (buttons.length > 0) {
        html += `<div class="grid grid-cols-${perRow} gap-2 mt-3">`;
        buttons.forEach(btn => {
            html += `<a href="${btn.url}" target="_blank" class="px-3 py-2 bg-blue-500 text-white text-center text-sm rounded hover:bg-blue-600">${btn.name}</a>`;
        });
        html += '</div>';
    }
    html += '</div>';
    
    document.getElementById('previewContent').innerHTML = html;
    showModal('previewModal');
}


async function saveMessage() {
        const data = {
        title: document.getElementById('messageTitle').value.trim() || 'æœªå‘½åç¾¤å‘',
        content: document.getElementById('messageContent').value,
        image_url: document.getElementById('imageUrl').value,
        video_url: document.getElementById('videoUrl').value,
        buttons: JSON.stringify(getButtons()),
        buttons_per_row: parseInt(document.getElementById('buttonsPerRow').value)
    };
    
    try {
        const editId = document.getElementById('editingId').value;
        const url = editId ? `/api/broadcast/message/${editId}` : '/api/broadcast/message';
        const method = editId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.success) {
            showToast('æˆåŠŸ', editId ? 'å·²æ›´æ–°' : 'å·²æ·»åŠ ');
            closeModal('messageModal');
            loadMessages();
        } else {
            showToast('å¤±è´¥', result.message || 'æ“ä½œå¤±è´¥', 'error');
        }
    } catch (error) {
        showToast('é”™è¯¯', error.message, 'error');
    }
}

async function editMessage(id) {
    try {
        const response = await fetch(`/api/broadcast/message/${id}`);
        const data = await response.json();
        if (!data.success) {
            showToast('åŠ è½½å¤±è´¥', data.message || 'è·å–æ¶ˆæ¯å¤±è´¥', 'error');
            return;
        }
        const m = data.message;
        
        document.getElementById('modalTitle').textContent = 'ç¼–è¾‘ç¾¤å‘å†…å®¹';
        document.getElementById('editingId').value = m.id;

        document.getElementById('messageTitle').value = m.title || '';
        document.getElementById('messageContent').value = m.content || '';
        document.getElementById('imageUrl').value = m.image_url || '';
        document.getElementById('videoUrl').value = m.video_url || '';
        // æ˜¾ç¤ºé¢„è§ˆ
        if (m.image_url) {
            const imgPreview = document.getElementById('imagePreview');
            imgPreview.classList.remove('hidden');
            imgPreview.querySelector('img').src = m.image_url;
        }
        if (m.video_url) {
            const vidPreview = document.getElementById('videoPreview');
            vidPreview.classList.remove('hidden');
            vidPreview.querySelector('video').src = m.video_url;
        }
        document.getElementById('buttonsPerRow').value = m.buttons_per_row || 2;
        // broadcastInterval removed from modal; per-message interval is edited in list

        // åŠ è½½æŒ‰é’®
        document.getElementById('buttonsList').innerHTML = '';
        buttonCount = 0;
        const buttons = m.buttons ? JSON.parse(m.buttons) : [];
        buttons.forEach(btn => {
            addButton();
            document.getElementById(`btn-name-${buttonCount}`).value = btn.name;
            document.getElementById(`btn-url-${buttonCount}`).value = btn.url;
        });
        
        showModal('messageModal');
    } catch (error) {
        showToast('åŠ è½½å¤±è´¥', error.message, 'error');
    }
}

async function deleteMessage(id) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç¾¤å‘å†…å®¹å—ï¼Ÿ')) return;
    try {
        const response = await fetch(`/api/broadcast/message/${id}`, {method: 'DELETE'});
        const result = await response.json();
        if (result.success) {
            showToast('æˆåŠŸ', 'å·²åˆ é™¤');
            loadMessages();
        }
    } catch (error) {
        showToast('åˆ é™¤å¤±è´¥', error.message, 'error');
    }
}

async function saveInterval(id) {
    const input = document.getElementById(`interval_${id}`);
    if (!input) return;
    const val = parseInt(input.value) || 0;
    try {
        const response = await fetch(`/api/broadcast/message/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ broadcast_interval: val })
        });
        const result = await response.json();
        if (result.success) {
            showToast('æˆåŠŸ', 'å·²ä¿å­˜é—´éš”');
            loadMessages(); // refresh list to reflect server values
        } else {
            showToast('å¤±è´¥', result.message || 'ä¿å­˜å¤±è´¥', 'error');
        }
    } catch (err) {
        showToast('é”™è¯¯', err.message, 'error');
    }
}


function showModal(id) { document.getElementById(id).classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }

document.addEventListener('DOMContentLoaded', () => {
    loadMessages();
});
</script>
{% endblock %}
