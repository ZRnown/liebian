{% extends "base.html" %}

{% block title %}æ•°æ®ç»Ÿè®¡ - è£‚å˜æœºå™¨äººåå°{% endblock %}

{% block content %}
<div class="container mx-auto px-6 py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-slate-800">ğŸ“Š æ•°æ®ç»Ÿè®¡</h1>
        <p class="text-slate-500 mt-2">å®æ—¶æŸ¥çœ‹ç³»ç»Ÿè¿è¥æ•°æ®</p>
    </div>

    <!-- æ ¸å¿ƒæ•°æ®å¡ç‰‡ -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- æ€»ä¼šå‘˜æ•° -->
        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 border border-blue-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-blue-600 text-sm font-medium">æ€»ä¼šå‘˜æ•°</p>
                    <h3 class="text-3xl font-bold text-blue-700 mt-2" id="total-members">0</h3>
                </div>
                <div class="w-12 h-12 bg-blue-500 rounded-lg flex items-center justify-center">
                    <i class="ti ti-users text-white text-2xl"></i>
                </div>
            </div>
        </div>

        <!-- VIPä¼šå‘˜æ•° -->
        <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-6 border border-purple-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-purple-600 text-sm font-medium">VIPä¼šå‘˜æ•°</p>
                    <h3 class="text-3xl font-bold text-purple-700 mt-2" id="vip-members">0</h3>
                </div>
                <div class="w-12 h-12 bg-purple-500 rounded-lg flex items-center justify-center">
                    <i class="ti ti-crown text-white text-2xl"></i>
                </div>
            </div>
        </div>

        <!-- ä»Šæ—¥æ³¨å†Œ -->
        <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6 border border-green-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-green-600 text-sm font-medium">ä»Šæ—¥æ³¨å†Œ</p>
                    <h3 class="text-3xl font-bold text-green-700 mt-2" id="today-register">0</h3>
                </div>
                <div class="w-12 h-12 bg-green-500 rounded-lg flex items-center justify-center">
                    <i class="ti ti-user-plus text-white text-2xl"></i>
                </div>
            </div>
        </div>

        <!-- ä»Šæ—¥å¼€é€šVIP -->
        <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl p-6 border border-orange-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-orange-600 text-sm font-medium">ä»Šæ—¥å¼€é€šVIP</p>
                    <h3 class="text-3xl font-bold text-orange-700 mt-2" id="today-vip">0</h3>
                </div>
                <div class="w-12 h-12 bg-orange-500 rounded-lg flex items-center justify-center">
                    <i class="ti ti-star text-white text-2xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- æ”¶ç›Šç»Ÿè®¡ -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- å¹³å°æ”¶ç›Šï¼ˆæ¡æ¼è´¦å·ï¼‰ -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <h2 class="text-lg font-semibold text-slate-800 mb-4 flex items-center">
                <i class="ti ti-coin text-yellow-500 mr-2"></i>
                å¹³å°æ”¶ç›Šï¼ˆæ¡æ¼è´¦å·å‰10åï¼‰
            </h2>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-slate-50 rounded-lg p-4">
                    <p class="text-slate-500 text-sm">ä»Šæ—¥æ”¶ç›Š</p>
                    <h3 class="text-2xl font-bold text-slate-800 mt-1" id="today-income">0 U</h3>
                </div>
                <div class="bg-slate-50 rounded-lg p-4">
                    <p class="text-slate-500 text-sm">æ˜¨æ—¥æ”¶ç›Š</p>
                    <h3 class="text-2xl font-bold text-slate-800 mt-1" id="yesterday-income">0 U</h3>
                </div>
                <div class="bg-slate-50 rounded-lg p-4">
                    <p class="text-slate-500 text-sm">æœ¬æœˆæ”¶ç›Š</p>
                    <h3 class="text-2xl font-bold text-slate-800 mt-1" id="month-income">0 U</h3>
                </div>
                <div class="bg-slate-50 rounded-lg p-4">
                    <p class="text-slate-500 text-sm">æ€»æ”¶ç›Š</p>
                    <h3 class="text-2xl font-bold text-slate-800 mt-1" id="total-income">0 U</h3>
                </div>
            </div>
        </div>

        <!-- æ³¨å†Œå¼€é€šè¶‹åŠ¿ -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <h2 class="text-lg font-semibold text-slate-800 mb-4 flex items-center">
                <i class="ti ti-chart-line text-indigo-500 mr-2"></i>
                æ³¨å†Œä¸å¼€é€šè¶‹åŠ¿
            </h2>
            <div class="space-y-3">
                <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                    <span class="text-slate-600">æ˜¨æ—¥æ³¨å†Œ</span>
                    <span class="font-semibold text-slate-800" id="yesterday-register">0</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                    <span class="text-slate-600">æ˜¨æ—¥å¼€é€šVIP</span>
                    <span class="font-semibold text-slate-800" id="yesterday-vip">0</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                    <span class="text-slate-600">æœ¬æœˆæ³¨å†Œ</span>
                    <span class="font-semibold text-slate-800" id="month-register">0</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                    <span class="text-slate-600">æœ¬æœˆå¼€é€šVIP</span>
                    <span class="font-semibold text-slate-800" id="month-vip">0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¡æ¼è´¦å·æ”¶ç›Šè¯¦æƒ… -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-8">
        <h2 class="text-lg font-semibold text-slate-800 mb-4 flex items-center">
            <i class="ti ti-trophy text-yellow-500 mr-2"></i>
            æ¡æ¼è´¦å·æ”¶ç›Šæ’è¡Œæ¦œ TOP 10
        </h2>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-slate-50">
                    <tr class="text-left text-sm text-slate-600">
                        <th class="px-4 py-3 rounded-tl-lg">æ’å</th>
                        <th class="px-4 py-3">è´¦å·å</th>
                        <th class="px-4 py-3">Telegram ID</th>
                        <th class="px-4 py-3">å½“å‰ä½™é¢</th>
                        <th class="px-4 py-3">ç´¯è®¡æ”¶ç›Š</th>
                        <th class="px-4 py-3 rounded-tr-lg">çŠ¶æ€</th>
                    </tr>
                </thead>
                <tbody id="fallback-accounts-table" class="text-sm">
                    <!-- åŠ¨æ€åŠ è½½ -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- 7æ—¥è¶‹åŠ¿å›¾è¡¨ -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
        <h2 class="text-lg font-semibold text-slate-800 mb-4 flex items-center">
            <i class="ti ti-chart-bar text-blue-500 mr-2"></i>
            è¿‘7æ—¥æ³¨å†Œä¸å¼€é€šVIPè¶‹åŠ¿
        </h2>
        <canvas id="trend-chart" height="80"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// åŠ è½½ç»Ÿè®¡æ•°æ®
async function loadDashboardStats() {
    try {
        const response = await fetch('/api/dashboard/stats');
        const data = await response.json();
        
        if (data.success) {
            const stats = data.data;
            
            // æ›´æ–°æ ¸å¿ƒæ•°æ®
            document.getElementById('total-members').textContent = stats.total_members || 0;
            document.getElementById('vip-members').textContent = stats.vip_members || 0;
            document.getElementById('today-register').textContent = stats.today_register || 0;
            document.getElementById('today-vip').textContent = stats.today_vip || 0;
            
            // æ›´æ–°æ”¶ç›Šæ•°æ®
            document.getElementById('today-income').textContent = (stats.today_income || 0) + ' U';
            document.getElementById('yesterday-income').textContent = (stats.yesterday_income || 0) + ' U';
            document.getElementById('month-income').textContent = (stats.month_income || 0) + ' U';
            document.getElementById('total-income').textContent = (stats.total_income || 0) + ' U';
            
            // æ›´æ–°è¶‹åŠ¿æ•°æ®
            document.getElementById('yesterday-register').textContent = stats.yesterday_register || 0;
            document.getElementById('yesterday-vip').textContent = stats.yesterday_vip || 0;
            document.getElementById('month-register').textContent = stats.month_register || 0;
            document.getElementById('month-vip').textContent = stats.month_vip || 0;
            
            // åŠ è½½æ¡æ¼è´¦å·æ’è¡Œ
            loadFallbackAccounts(stats.fallback_accounts || []);
            
            // ç»˜åˆ¶è¶‹åŠ¿å›¾
            drawTrendChart(stats.trend_data || {});
        }
    } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
    }
}

// åŠ è½½æ¡æ¼è´¦å·æ’è¡Œ
function loadFallbackAccounts(accounts) {
    const tbody = document.getElementById('fallback-accounts-table');
    tbody.innerHTML = '';
    
    accounts.forEach((account, index) => {
        const tr = document.createElement('tr');
        tr.className = 'border-b border-slate-100 hover:bg-slate-50';
        
        const rankClass = index === 0 ? 'text-yellow-500' : index === 1 ? 'text-slate-400' : index === 2 ? 'text-orange-400' : 'text-slate-600';
        
        tr.innerHTML = `
            <td class="px-4 py-3">
                <span class="font-bold ${rankClass}">
                    ${index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : '#' + (index + 1)}
                </span>
            </td>
            <td class="px-4 py-3 font-medium text-slate-800">${account.username || 'æœªçŸ¥'}</td>
            <td class="px-4 py-3 text-slate-600">${account.telegram_id || '-'}</td>
            <td class="px-4 py-3 font-semibold text-green-600">${account.balance || 0} U</td>
            <td class="px-4 py-3 font-semibold text-blue-600">${account.total_earned || 0} U</td>
            <td class="px-4 py-3">
                <span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs">
                    ${account.is_vip ? 'VIP' : 'æ™®é€š'}
                </span>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// ç»˜åˆ¶è¶‹åŠ¿å›¾è¡¨
let trendChart = null;
function drawTrendChart(trendData) {
    const ctx = document.getElementById('trend-chart');
    
    if (trendChart) {
        trendChart.destroy();
    }
    
    trendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: trendData.labels || [],
            datasets: [
                {
                    label: 'æ³¨å†Œäººæ•°',
                    data: trendData.register_counts || [],
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'å¼€é€šVIP',
                    data: trendData.vip_counts || [],
                    borderColor: 'rgb(168, 85, 247)',
                    backgroundColor: 'rgba(168, 85, 247, 0.1)',
                    tension: 0.4,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

// é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardStats();
    
    // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡æ•°æ®
    setInterval(loadDashboardStats, 30000);
});
</script>
{% endblock %}
