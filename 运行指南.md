# 🚀 项目运行指南

## 前置要求

- Python 3.7 或更高版本
- pip3 包管理器
- Telegram Bot Token（从 @BotFather 获取）
- Telegram API ID 和 API Hash（从 https://my.telegram.org 获取）

## 快速开始

### 1️⃣ 安装依赖

```bash
# 进入项目目录
cd /Users/wanghaixin/Development/telegramBotWork/liebian.mifzla.top

# 安装Python依赖
pip3 install -r requirements.txt
```

### 2️⃣ 配置参数

编辑 `app/main.py` 文件，修改以下配置（第37-43行）：

```python
# 配置
API_ID = 21332425  # 替换为你的 API ID
API_HASH = 'f5d0cddc784e3a7a09ea9714ed01f238'  # 替换为你的 API Hash
BOT_TOKEN = '8282974213:AAEISGP5ijUbJSBMA9N5eoygWjAB266-1UE'  # 替换为你的 Bot Token

# 管理员列表
ADMIN_IDS = [7935612165]  # 替换为你的 Telegram 用户 ID
```

**如何获取这些参数：**

1. **BOT_TOKEN**: 
   - 在 Telegram 中搜索 `@BotFather`
   - 发送 `/newbot` 创建新机器人
   - 按提示操作，最后会获得 Bot Token

2. **API_ID 和 API_HASH**:
   - 访问 https://my.telegram.org
   - 使用手机号登录
   - 进入 "API development tools"
   - 创建应用后获得 API ID 和 API Hash

3. **ADMIN_IDS**:
   - 在 Telegram 中搜索 `@userinfobot`
   - 发送任意消息，它会返回你的用户 ID

### 3️⃣ 启动项目

#### 方式一：使用启动脚本（推荐）

```bash
# 给脚本添加执行权限（首次运行）
chmod +x scripts/start.sh

# 启动项目
./scripts/start.sh
```

#### 方式二：直接运行 Python

```bash
# 在项目根目录运行
python3 -m app.main
```

#### 方式三：后台运行（生产环境）

```bash
# 使用 nohup 后台运行
nohup python3 -m app.main > data/bot.log 2>&1 &
echo $! > data/bot.pid
```

### 4️⃣ 验证运行状态

启动成功后，你会看到类似输出：

```
============================================================
🤖 裂变推广机器人启动中...
============================================================

📊 初始化数据库...
✅ 数据库初始化完成

🌐 启动Web管理后台...
✅ Web管理后台已启动

🚀 Telegram机器人已启动

============================================================
📱 访问地址：
   服务器访问：http://liebian.mifzla.top
   本地访问：http://localhost:5051
============================================================
```

### 5️⃣ 访问管理后台

- **地址**: http://localhost:5051
- **默认账号**: `admin`
- **默认密码**: `admin`
- ⚠️ **首次登录后请立即修改密码！**

## 停止项目

### 方式一：使用停止脚本

```bash
chmod +x scripts/stop.sh
./scripts/stop.sh
```

### 方式二：手动停止

```bash
# 如果使用启动脚本，会生成 PID 文件
kill $(cat data/bot.pid)
rm data/bot.pid
```

### 方式三：查找进程停止

```bash
# 查找进程
ps aux | grep "app.main"

# 停止进程（替换 PID 为实际进程号）
kill <PID>
```

## 查看日志

```bash
# 实时查看日志
tail -f data/bot.log

# 查看最近100行日志
tail -n 100 data/bot.log
```

## 常见问题

### 1. 端口被占用

如果 5051 端口被占用，可以修改 `app/main.py` 中的端口号：

```python
# 第5337行附近
app.run(debug=False, host='0.0.0.0', port=5051, use_reloader=False)
```

### 2. 数据库初始化失败

确保 `data/` 目录有写入权限：

```bash
chmod -R 755 data/
```

### 3. 依赖安装失败

尝试使用国内镜像源：

```bash
pip3 install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### 4. Telegram 连接失败

如果在中国大陆，可能需要配置代理。编辑 `app/main.py`：

```python
# 第469行附近
USE_PROXY = True  # 改为 True
if USE_PROXY:
    proxy = (socks.SOCKS5, '127.0.0.1', 7897)  # 修改为你的代理地址和端口
```

## 项目结构说明

```
liebian.mifzla.top/
├── app/                    # 应用核心代码
│   ├── main.py            # 主程序入口
│   ├── config.py          # 配置文件
│   └── ...
├── data/                  # 数据目录（运行时生成）
│   ├── bot.db            # SQLite数据库
│   ├── bot.log           # 运行日志
│   └── bot.pid           # 进程ID文件
├── templates/            # HTML模板
├── static/               # 静态文件
├── scripts/              # 工具脚本
│   ├── start.sh         # 启动脚本
│   └── stop.sh          # 停止脚本
└── requirements.txt      # Python依赖
```

## 生产环境部署建议

1. **使用 systemd 管理服务**（Linux）
2. **配置 Nginx 反向代理**（可选）
3. **定期备份数据库** (`data/bot.db`)
4. **设置日志轮转**，避免日志文件过大
5. **使用虚拟环境**（venv）隔离依赖

## 下一步

- ✅ 测试机器人功能
- ✅ 配置系统参数（层数、奖励等）
- ✅ 添加管理员账号
- ✅ 配置客服信息
- ✅ 上传行业资源

---

如有问题，请查看日志文件 `data/bot.log` 或检查配置是否正确。

